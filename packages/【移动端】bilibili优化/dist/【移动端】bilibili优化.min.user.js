// ==UserScript==
// @name         【移动端】bilibili优化
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2024.5.29
// @author       WhiteSevs
// @description  bilibili(哔哩哔哩)优化，免登录等
// @license      GPL-3.0-only
// @icon         https://i0.hdslb.com/bfs/static/jinkela/long/images/512.png
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://m.bilibili.com/*
// @match        *://live.bilibili.com/*
// @require      https://update.greasyfork.org/scripts/494167/1376186/CoverUMD.js
// @require      https://update.greasyfork.org/scripts/456485/1384984/pops.js
// @require      https://cdn.jsdelivr.net/npm/qmsg@1.1.0/dist/index.umd.js
// @require      https://cdn.jsdelivr.net/npm/@whitesev/utils@1.2.1/dist/index.umd.js
// @require      https://cdn.jsdelivr.net/npm/@whitesev/domutils@1.1.0/dist/index.umd.js
// @connect      *
// @connect      m.bilibili.com
// @connect      www.bilibili.com
// @connect      api.bilibili.com
// @grant        GM_addStyle
// @grant        GM_deleteValue
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(n=>{function a(p){if(typeof p!="string")throw new TypeError("cssText must be a string");let e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=p,document.head?document.head.appendChild(e):document.body?document.body.appendChild(e):document.documentElement.childNodes.length===0?document.documentElement.appendChild(e):document.documentElement.insertBefore(e,document.documentElement.childNodes[0]),e}if(typeof GM_addStyle=="function"){GM_addStyle(n);return}a(n)})(" .m-video2-awaken-btn,.m-home .launch-app-btn.home-float-openapp,.m-space .launch-app-btn.m-space-float-openapp,.m-space .launch-app-btn.m-nav-openapp{display:none!important}#app .video .openapp-dialog,#app .video .launch-app-btn.m-video-main-launchapp:has([class^=m-video2-awaken]),#app .video .launch-app-btn.m-nav-openapp,#app .video .mplayer-widescreen-callapp,#app .video .launch-app-btn.m-float-openapp{display:none!important}#app.LIVE .open-app-btn.bili-btn-warp{display:none!important} ");

(function (y, D, T) {
        'use strict';

        var C=typeof GM_addStyle<"u"?GM_addStyle:void 0,v=typeof GM_getValue<"u"?GM_getValue:void 0,x=typeof GM_info<"u"?GM_info:void 0,U=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,M=typeof GM_setValue<"u"?GM_setValue:void 0,G=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,N=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,u=typeof unsafeWindow<"u"?unsafeWindow:void 0,O=window;const L="【移动端】bilibili优化",o=D.noConflict(),m=T.noConflict(),R=O.pops||u.pops,r=new o.Log(x,u.console||O.console);var B;const P=((B=x==null?void 0:x.script)==null?void 0:B.name)||L,S=!1;r.config({debug:S,logMaxCount:2e4,autoClearConsole:!0,tag:!0});y.config({position:"bottom",html:!0,maxNums:5,autoClose:!0,showClose:!1,showReverse:!0});const $=new o.GM_Menu({GM_getValue:v,GM_setValue:M,GM_registerMenuCommand:U,GM_unregisterMenuCommand:G}),W=new o.Httpx(N);W.config({logDetails:S,onabort(){y.warning("请求取消");},ontimeout(){y.error("请求超时");},onerror(e){y.error("请求异常"),r.error(["httpx-onerror 请求异常",e]);}});const H={Object:{defineProperty:u.Object.defineProperty},Function:{apply:u.Function.prototype.apply,call:u.Function.prototype.call},Element:{appendChild:u.Element.prototype.appendChild},setTimeout:u.setTimeout},g="GM_Panel",A="data-key",V="data-default-value",p=function(e,i,t,n,a){let s={text:e,type:"switch",description:a,attributes:{},getValue(){return !!l.getValue(i,t)},callback(f,c){r.success(`${c?"开启":"关闭"} ${e}`),l.setValue(i,!!c);},afterAddToUListCallBack:void 0};return s.attributes[A]=i,s.attributes[V]=!!t,s},j={id:"panel-common",title:"通用",forms:[{text:"功能",type:"forms",forms:[p("监听路由改变","bili-listenRouterChange",!1,void 0,"用于处理页面跳转时功能不生效问题")]},{text:"变量设置",type:"forms",forms:[p("isLogin","bili-setLogin",!1,void 0,"设置isLogin为true"),p("isClient","bili-setIsClient",!1,void 0,"设置isClient为true"),p("tinyApp","bili-setTinyApp",!1,void 0,"设置tinyApp为true")]},{text:"劫持/拦截",type:"forms",forms:[p("阻止调用App","bili-video-hook-callApp",!1,void 0,"处理函数: PlayerAgent")]}]},h={isVideo(){return window.location.pathname.startsWith("/video/")},isBangumi(){return window.location.pathname.startsWith("/bangumi/")},isSearch(){return window.location.pathname.startsWith("/search")},isLive(){return window.location.hostname==="live.bilibili.com"}},q={id:"panel-video",title:"视频",isDefault(){return h.isVideo()},forms:[{text:"功能",type:"forms",forms:[]},{text:"变量设置",type:"forms",forms:[p("playBtnNoOpenApp","bili-video-setVideoPlayer",!1,void 0,"设置playBtnNoOpenApp为true,playBtnOpenApp为false,coverOpenApp为false")]}]},F={id:"panel-bangumi",title:"番剧",isDefault(){return h.isBangumi()},forms:[{text:"变量设置",type:"forms",forms:[p("pay","bili-bangumi-setPay",!1,void 0,"设置pay为1")]},{text:"覆盖点击事件",type:"forms",forms:[p("【选集】","bili-bangumi-cover-clicl-event-chooseEp",!1,void 0,"让【选集】的视频列表可点击跳转"),p("【其它】","bili-bangumi-cover-clicl-event-other",!1,void 0,"让【PV&其他】、【预告】、【主题曲】、【香境剧场】等的视频列表可点击跳转"),p("【更多推荐】","bili-bangumi-cover-clicl-event-recommend",!1,void 0,"让【更多推荐】的视频列表可点击跳转")]},{text:"劫持/拦截",type:"forms",forms:[p("阻止调用App","bili-bangumi-hook-callApp",!1,void 0,"")]}]},K={id:"panel-search",title:"搜索",isDefault(){return h.isSearch()},forms:[{text:"功能",type:"forms",forms:[p("修复点击UP主正确进入空间","bili-search-repair-enter-user-home",!1,void 0,"可以修复点击UP主进入个人空间但是是404问题")]}]},Y={id:"panel-live",title:"直播",isDefault(){return h.isLive()},forms:[{text:"功能",type:"forms",forms:[p("阻止open-app-btn元素点击事件触发","bili-live-prevent-openAppBtn",!1,void 0,"开启后可不跳转至唤醒App页面"),p("【屏蔽】聊天室","bili-live-block-chatRoom",!1,void 0,"直接不显示底部的聊天室"),p("【屏蔽】xxx进入直播间","bili-live-block-brush-prompt",!1,void 0,"直接不显示底部的xxx进入直播间"),p("【屏蔽】控制面板","bili-live-block-control-panel",!1,void 0,"屏蔽底部的发个弹幕、送礼")]}]},l={$data:{data:new o.Dictionary,oneSuccessExecMenu:new o.Dictionary,onceExec:new o.Dictionary,scriptName:P,key:g,attributeKeyName:A,attributeDefaultValueName:V},$listener:{listenData:new o.Dictionary},init(){this.initPanelDefaultValue(),this.initExtensionsMenu();},initExtensionsMenu(){u.top===u.self&&$.add([{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:!1,isStoreValue:!1,showText(e){return e},callback:()=>{this.showPanel();}}]);},initPanelDefaultValue(){let e=this;function i(n){if(!n.attributes)return;let a=n.attributes[A],s=n.attributes[V];if(a==null){r.warn(["请先配置键",n]);return}e.$data.data.has(a)&&r.warn("请检查该key(已存在): "+a),e.$data.data.set(a,s);}let t=this.getPanelContentConfig();for(let n=0;n<t.length;n++){let a=t[n];if(!a.forms)continue;let s=a.forms;for(let f=0;f<s.length;f++){let c=s[f];if(c.forms){let b=c.forms;for(let d=0;d<b.length;d++)i(b[d]);}else i(c);}}},setValue(e,i){let t=v(g,{}),n=t[e];t[e]=i,M(g,t),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,n,i);},getValue(e,i){let n=v(g,{})[e];return n??(this.$data.data.has(e)?this.$data.data.get(e):i)},deleteValue(e){let i=v(g,{}),t=i[e];Reflect.deleteProperty(i,e),M(g,i),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,t,void 0);},addValueChangeListener(e,i){let t=Math.random();return this.$listener.listenData.set(e,{id:t,key:e,callback:i}),t},removeValueChangeListener(e){let i=null;for(const[t,n]of this.$listener.listenData.entries())if(n.id===e){i=t;break}this.$listener.listenData.delete(i);},hasValue(e){let i=v(g,{});return e in i},execMenu(e,i){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!l.hasValue(e)){r.warn(`${e} 键不存在`);return}let t=l.getValue(e);t&&i(t);},execMenuOnce(e,i){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!l.hasValue(e)){r.warn(`${e} 键不存在`);return}let t=l.getValue(e);if(t){if(this.$data.oneSuccessExecMenu.has(e))return;i(t),this.$data.oneSuccessExecMenu.set(e,1);}},onceExec(e,i){if(typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExec.has(e)||(i(),this.$data.onceExec.set(e,1));},showPanel(){R.panel({title:{text:`${P}-设置`,position:"center",html:!1,style:""},content:this.getPanelContentConfig(),mask:{enable:!0,clickEvent:{toClose:!0,toHide:!1}},isMobile:this.isMobile(),width:this.getWidth(),height:this.getHeight(),drag:!0,only:!0});},isMobile(){return window.outerWidth<550},getWidth(){return window.outerWidth<550?"92dvw":"550px"},getHeight(){return window.outerHeight>450?"80dvh":"450px"},getPanelContentConfig(){return [j,q,F,K,Y]}},Q={hookPlayerAgent(){let e;H.Object.defineProperty(u,"PlayerAgent",{get(){return new Proxy({},{get(i,t){return t==="openApp"?function(...n){let a=n[0];r.info(["调用PlayerAgent.openApp",a]);}:e[t]}})},set(i){e=i;}});}},z={init(){l.execMenuOnce("bili-video-hook-callApp",()=>{Q.hookPlayerAgent();});}},J={init(){z.init(),l.execMenu("bili-video-setVideoPlayer",()=>{this.setVideoPlayer();});},setVideoPlayer(){o.waitNode(".m-video-player").then(e=>{let i=function(t){return t!=null&&typeof t.playBtnNoOpenApp=="boolean"&&typeof t.playBtnOpenApp=="boolean"&&typeof t.coverOpenApp=="boolean"};o.waitVueByInterval(()=>document.querySelector(".m-video-player"),i,250,1e4).then(()=>{e=document.querySelector(".m-video-player"),i(e.__vue__)&&(r.success("成功设置参数 playBtnNoOpenApp、playBtnOpenApp、coverOpenApp"),e.__vue__.playBtnNoOpenApp=!0,e.__vue__.playBtnOpenApp=!1,e.__vue__.coverOpenApp=!1);});});}},w={getUrl(e){if(e!=null)return e.getAttribute("universallink")},jumpToUrl(e){let t=e.target.querySelector("bili-open-app");if(t){let n=w.getUrl(t);n?window.location.href=n:(y.error("获取bili-open-app的Url失败"),r.error("获取bili-open-app的Url失败"));}else y.error("未获取到<bili-open-app>元素"),r.error("未获取到<bili-open-app>元素");}},X={init(){l.execMenuOnce("bili-bangumi-hook-callApp",()=>{this.hookCallApp();}),l.execMenu("bili-bangumi-setPay",()=>{this.setPay();}),l.execMenu("bili-bangumi-cover-clicl-event-chooseEp",()=>{this.setChooseEpClickEvent();}),l.execMenu("bili-bangumi-cover-clicl-event-other",()=>{this.setClickOtherVideo();}),l.execMenu("bili-bangumi-cover-clicl-event-recommend",()=>{this.setRecommendClickEvent();});},hookCallApp(){let e=u.setTimeout;u.setTimeout=function(...i){if(i[0].toString().includes("autoOpenApp")){r.success(["阻止唤醒App",i]);return}return e.apply(this,i)};},setPay(){o.waitNode("#app").then(e=>{let i=function(t){var n,a,s;return t!=null&&typeof((s=(a=(n=t==null?void 0:t.$store)==null?void 0:n.state)==null?void 0:a.userStat)==null?void 0:s.pay)=="number"};o.waitVueByInterval(e,i,250,1e4).then(()=>{i(e.__vue__)&&(r.success("成功设置参数 pay"),e.__vue__.$store.state.userStat.pay=1);});});},setChooseEpClickEvent(){o.waitNode(".ep-list-pre-wrapper ul.ep-list-pre-container").then(()=>{r.info("覆盖【选集】的点击事件"),m.on(".ep-list-pre-wrapper ul.ep-list-pre-container","click","li.episode-item",function(e){o.preventEvent(e),w.jumpToUrl(e);},{capture:!0});}),o.waitNode(".ep-list-pre-wrapper ul.season-list-wrapper").then(()=>{r.info("覆盖【xx季】的点击事件"),m.on(".ep-list-pre-wrapper ul.season-list-wrapper","click","li",function(e){o.preventEvent(e),w.jumpToUrl(e);},{capture:!0});}),o.waitNode(".ep-list-pre-header").then(()=>{r.info("覆盖【选集】右上角的【全xx话】Arrow的点击事件"),m.on(".ep-list-pre-header","click",function(e){o.preventEvent(e);},{capture:!0});});},setClickOtherVideo(){o.waitNode(".section-preview-wrapper ul.ep-list-pre-container").then(()=>{r.info("覆盖【PV&其他】、【预告】、【主题曲】的点击事件"),m.on(".section-preview-wrapper .ep-list-pre-container","click","li.section-preview-item",function(e){o.preventEvent(e),w.jumpToUrl(e);},{capture:!0});}),o.waitNode(".section-preview-header").then(()=>{r.info("覆盖【PV&其他】、【预告】、【主题曲】右上角的Arrow的点击事件"),m.on(".section-preview-header","click",function(e){o.preventEvent(e);},{capture:!0});});},setRecommendClickEvent(){o.waitNode(".recom-wrapper ul.recom-list").then(()=>{r.info("覆盖【更多推荐】番剧的点击事件"),m.on(".recom-wrapper ul.recom-list","click","li.recom-item-v2",function(e){o.preventEvent(e),w.jumpToUrl(e);},{capture:!0});});}},Z={init(){l.execMenuOnce("bili-search-repair-enter-user-home",()=>{this.repairEnterUserHome();});},repairEnterUserHome(){o.waitNode(".result-panel").then(e=>{r.info("修复点击UP主正确进入空间"),m.on(e,"click","a.m-search-user-item[href]",function(i){o.preventEvent(i);let n=i.target.href;r.success("链接跳转: "+n),window.location.href=n;},{capture:!0});});}},_={init(){l.execMenuOnce("bili-live-prevent-openAppBtn",()=>{this.preventOpenAppBtn();}),l.execMenuOnce("bili-live-block-chatRoom",()=>{this.blockChatRoom();}),l.execMenuOnce("bili-live-block-brush-prompt",()=>{this.blockBrushPrompt();}),l.execMenuOnce("bili-live-block-control-panel",()=>{this.blockControlPanel();});},preventOpenAppBtn(){o.waitNode("body").then(e=>{r.info("阻止.open-app-btn元素触发点击事件"),m.on(e,"click",".open-app-btn",function(i){o.preventEvent(i);},{capture:!0}),m.on(e,"click","#web-player-controller-wrap-el",function(i){o.preventEvent(i);},{capture:!0});});},blockChatRoom(){r.info("屏蔽聊天室"),C(`
        #chat-items{
            display: none !important;
        }
        `);},blockBrushPrompt(){r.info("屏蔽xxx进入直播间"),C(`
        #brush-prompt{
            display: none !important;
        }
        `);},blockControlPanel(){r.info("屏蔽底部工具栏"),C(`
        .control-panel{
            display: none !important;
        }`);}},I={init(){l.execMenu("bili-setLogin",()=>{this.setLogin();}),l.execMenu("bili-setIsClient",()=>{this.setIsClient();}),l.execMenu("bili-setTinyApp",()=>{this.setTinyApp();}),l.execMenuOnce("bili-listenRouterChange",()=>{this.listenRouterChange();}),h.isVideo()?(r.info("Router: 视频稿件"),J.init()):h.isBangumi()?(r.info("Router: 番剧"),X.init()):h.isSearch()?(r.info("Router: 搜索"),Z.init()):h.isLive()&&(r.info("Router: 直播"),_.init());},setLogin(){o.waitNode("#app").then(e=>{let i=function(t){var n,a,s,f,c,b,d;return t!=null&&typeof((s=(a=(n=t==null?void 0:t.$store)==null?void 0:n.state)==null?void 0:a.common)==null?void 0:s.noCallApp)=="boolean"&&typeof((d=(b=(c=(f=t==null?void 0:t.$store)==null?void 0:f.state)==null?void 0:c.common)==null?void 0:b.userInfo)==null?void 0:d.isLogin)=="boolean"};o.waitVueByInterval(e,i,250,1e4).then(()=>{i(e.__vue__)&&(r.success("成功设置参数 noCallApp isLogin"),e.__vue__.$store.state.common.noCallApp=!0,e.__vue__.$store.state.common.userInfo.isLogin=!0);});});},setIsClient(){o.waitNode("#app").then(e=>{let i=function(t){var n,a,s,f,c,b,d,E,k;return t!=null&&typeof((s=(a=(n=t==null?void 0:t.$store)==null?void 0:n.state)==null?void 0:a.video)==null?void 0:s.isClient)=="boolean"&&typeof((b=(c=(f=t==null?void 0:t.$store)==null?void 0:f.state)==null?void 0:c.opus)==null?void 0:b.isClient)=="boolean"&&typeof((k=(E=(d=t==null?void 0:t.$store)==null?void 0:d.state)==null?void 0:E.playlist)==null?void 0:k.isClient)=="boolean"};o.waitVueByInterval(e,i,250,1e4).then(()=>{i(e.__vue__)&&(e.__vue__.$store.state.video.isClient=!0,e.__vue__.$store.state.opus.isClient=!0,e.__vue__.$store.state.playlist.isClient=!0);});});},setTinyApp(){o.waitNode("#app").then(e=>{let i=function(t){var n,a,s;return typeof((s=(a=(n=t==null?void 0:t.$store)==null?void 0:n.state)==null?void 0:a.common)==null?void 0:s.tinyApp)=="boolean"};o.waitVueByInterval(e,i,250,1e4).then(()=>{i(e.__vue__)&&(e.__vue__.$store.state.common.tinyApp=!0,r.success("成功设置参数 tinyApp"),setTimeout(()=>{if(!document.querySelector("#bilibiliPlayer video")){let t=function(n){return typeof(n==null?void 0:n.initPlayer)=="function"};o.waitNode(".m-video-player").then(n=>{o.waitVueByInterval(n,t,250,1e4).then(()=>{t(n.__vue__)&&(r.success("成功调用函数 initPlayer()"),n.__vue__.initPlayer());});});}},2e3));});}),h.isVideo()&&l.onceExec("bili-video-repair-bottom-recommend-video-margin-top",()=>{C(`
                /* 修复一下底部推荐视频的margin-top */
                .m-video-bottom-tab .v-switcher__content--multi{
                    margin-top: 34vmin;
                }
                `);});},listenRouterChange(){o.waitNode("#app").then(e=>{let i=function(t){var n;return typeof((n=t==null?void 0:t.$router)==null?void 0:n.afterEach)=="function"};o.waitVueByInterval(e,i).then(()=>{i(e.__vue__)&&(r.success("成功设置监听路由变化"),e.__vue__.$router.afterEach((t,n)=>{r.success(["路由变化",[t,n]]),I.init();}));});});}};l.init();I.init();

})(Qmsg, Utils, DOMUtils);