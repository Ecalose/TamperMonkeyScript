// ==UserScript==
// @name         Demo Script Name
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2024.7.5
// @author       WhiteSevs
// @description
// @license      GPL-3.0-only
// @icon
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match
// @require      https://update.greasyfork.org/scripts/494167/1376186/CoverUMD.js
// @require      https://update.greasyfork.org/scripts/456485/1405857/pops.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.1.2/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@1.5.9/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.1.2/dist/index.umd.js
// @connect
// @grant        GM_addStyle
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(function (g, k, C) {
	'use strict';

	var m=typeof GM_getValue<"u"?GM_getValue:void 0,p=typeof GM_info<"u"?GM_info:void 0,I=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,_=typeof GM_setValue<"u"?GM_setValue:void 0,S=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,N=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,f=typeof unsafeWindow<"u"?unsafeWindow:void 0,y=window;const R={$data:{get enable(){return s.getValue("httpx-use-cookie-enable")},get useDocumentCookie(){return s.getValue("httpx-use-document-cookie")},cookieRule:[]},fixCookieSplit(e){return u.isNotNull(e)&&!e.trim().endsWith(";")&&(e+=";"),e},concatCookie(e,t){return u.isNull(e)?t:(e=e.trim(),t=t.trim(),e=this.fixCookieSplit(e),t.startsWith(";")&&(t=t.substring(1)),e.concat(t))},handle(e){if(e.fetch||!this.$data.enable)return;let t="",n=e.url;n.startsWith("//")&&(n=window.location.protocol+n);let a=new URL(n);this.$data.useDocumentCookie&&a.hostname.endsWith(window.location.hostname.split(".").slice(-2).join("."))&&(t=this.concatCookie(t,document.cookie.trim()));for(let i=0;i<this.$data.cookieRule.length;i++){let o=this.$data.cookieRule[i];if(a.hostname.match(o.hostname)){let l=s.getValue(o.key);if(u.isNull(l))break;t=this.concatCookie(t,l);}}u.isNotNull(t)&&(e.headers&&e.headers.Cookie?e.headers.Cookie=this.concatCookie(e.headers.Cookie,t):e.headers.Cookie=t,d.info(["Httpx => 设置cookie:",e])),e.headers&&e.headers.Cookie!=null&&u.isNull(e.headers.Cookie)&&delete e.headers.Cookie;}},U="Demo Script Name",u=C.noConflict();k.noConflict();const $=y.pops||f.pops,d=new u.Log(p,f.console||y.console);var E;const V=((E=p==null?void 0:p.script)==null?void 0:E.name)||U,G=!1;d.config({debug:G,logMaxCount:1e3,autoClearConsole:!0,tag:!0});g.config(Object.defineProperties({html:!0,autoClose:!0,showClose:!1},{position:{get(){return s.getValue("qmsg-config-position","bottom")}},maxNums:{get(){return s.getValue("qmsg-config-maxnums",5)}},showReverse:{get(){return s.getValue("qmsg-config-showreverse",!0)}},zIndex:{get(){let e=C.getMaxZIndex(),t=$.config.Utils.getPopsMaxZIndex(e).zIndex;return C.getMaxValue(e,t)+100}}}));const W=new u.GM_Menu({GM_getValue:m,GM_setValue:_,GM_registerMenuCommand:I,GM_unregisterMenuCommand:S}),w=new u.Httpx(N);w.interceptors.request.use(e=>(R.handle(e),e));w.interceptors.response.use(void 0,e=>(d.error(["拦截器-请求错误",e]),e.type==="onabort"?g.warning("请求取消"):e.type==="onerror"?g.error("请求异常"):e.type==="ontimeout"?g.error("请求超时"):g.error("其它错误"),e));w.config({logDetails:G});f.Object.defineProperty,f.Function.prototype.apply,f.Function.prototype.call,f.Element.prototype.appendChild,f.setTimeout;const h="GM_Panel",x="data-key",M="data-default-value",v=function(e,t,n,a,i){let o={text:e,type:"switch",description:i,attributes:{},getValue(){return !!s.getValue(t,n)},callback(l,c){d.success(`${c?"开启":"关闭"} ${e}`),s.setValue(t,!!c);},afterAddToUListCallBack:void 0};return o.attributes&&(o.attributes[x]=t,o.attributes[M]=!!n),o},D=function(e,t,n,a,i,o){let l=[];typeof a=="function"?l=a():l=a;let c={text:e,type:"select",description:o,attributes:{},getValue(){return s.getValue(t,n)},callback(T,b,P){s.setValue(t,b),typeof i=="function"&&i(T,b,P);},data:l};return c.attributes&&(c.attributes[x]=t,c.attributes[M]=n),c},A={id:"component-common",title:"通用",forms:[{text:"Toast配置",type:"forms",forms:[D("Toast位置","qmsg-config-position","bottom",[{value:"topleft",text:"左上角"},{value:"top",text:"顶部"},{value:"topright",text:"右上角"},{value:"left",text:"左边"},{value:"center",text:"中间"},{value:"right",text:"右边"},{value:"bottomleft",text:"左下角"},{value:"bottom",text:"底部"},{value:"bottomright",text:"右下角"}],(e,t,n)=>{d.info("设置当前Qmsg弹出位置"+n);},"Toast显示在页面九宫格的位置"),D("最多显示的数量","qmsg-config-maxnums",3,[{value:1,text:"1"},{value:2,text:"2"},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],void 0,"限制Toast显示的数量"),v("逆序弹出","qmsg-config-showreverse",!1,void 0,"修改Toast弹出的顺序")]},{text:"Cookie配置",type:"forms",forms:[v("启用","httpx-use-cookie-enable",!1,void 0,"启用后，将根据下面的配置进行添加cookie"),v("使用document.cookie","httpx-use-document-cookie",!1,void 0,"自动根据请求的域名来设置对应的cookie")]}]},r={data:null,oneSuccessExecMenu:null,onceExec:null,listenData:null},s={$data:{get data(){return r.data==null&&(r.data=new u.Dictionary),r.data},get oneSuccessExecMenu(){return r.oneSuccessExecMenu==null&&(r.oneSuccessExecMenu=new u.Dictionary),r.oneSuccessExecMenu},get onceExec(){return r.onceExec==null&&(r.onceExec=new u.Dictionary),r.onceExec},get scriptName(){return V},key:h,attributeKeyName:x,attributeDefaultValueName:M},$listener:{get listenData(){return r.listenData==null&&(r.listenData=new u.Dictionary),r.listenData}},init(){this.initPanelDefaultValue(),this.initExtensionsMenu();},initExtensionsMenu(){f.top===f.self&&W.add([{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:!1,isStoreValue:!1,showText(e){return e},callback:()=>{this.showPanel();}}]);},initPanelDefaultValue(){let e=this;function t(i){if(!i.attributes)return;let o=i.attributes[x],l=i.attributes[M];if(o==null){d.warn(["请先配置键",i]);return}e.$data.data.has(o)&&d.warn("请检查该key(已存在): "+o),e.$data.data.set(o,l);}function n(i){for(let o=0;o<i.length;o++){let l=i[o];t(l);let c=l.forms;c&&Array.isArray(c)&&n(c);}}let a=this.getPanelContentConfig();for(let i=0;i<a.length;i++){let o=a[i];if(!o.forms)continue;let l=o.forms;l&&Array.isArray(l)&&n(l);}},setValue(e,t){let n=m(h,{}),a=n[e];n[e]=t,_(h,n),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,a,t);},getValue(e,t){let a=m(h,{})[e];return a??(this.$data.data.has(e)?this.$data.data.get(e):t)},deleteValue(e){let t=m(h,{}),n=t[e];Reflect.deleteProperty(t,e),_(h,t),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,n,void 0);},addValueChangeListener(e,t){let n=Math.random();return this.$listener.listenData.set(e,{id:n,key:e,callback:t}),n},removeValueChangeListener(e){let t=null;for(const[n,a]of this.$listener.listenData.entries())if(a.id===e){t=n;break}typeof t=="string"?this.$listener.listenData.delete(t):console.warn("没有找到对应的监听器");},hasKey(e){let t=m(h,{});return e in t},execMenu(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){d.warn(`${e} 键不存在`);return}let n=s.getValue(e);n&&t(n);},execMenuOnce(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){d.warn(`${e} 键不存在`);return}let n=s.getValue(e);if(n){if(this.$data.oneSuccessExecMenu.has(e))return;t(n),this.$data.oneSuccessExecMenu.set(e,1);}},onceExec(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExec.has(e)||(t(),this.$data.onceExec.set(e,1));},showPanel(){$.panel({title:{text:`${V}-设置`,position:"center",html:!1,style:""},content:this.getPanelContentConfig(),mask:{enable:!0,clickEvent:{toClose:!0,toHide:!1}},isMobile:this.isMobile(),width:this.getWidth(),height:this.getHeight(),drag:!0,only:!0});},isMobile(){return window.outerWidth<550},getWidth(){return window.outerWidth<550?"92dvw":"550px"},getHeight(){return window.outerHeight>450?"80dvh":"450px"},getPanelContentConfig(){return [A]}};s.init();

})(Qmsg, DOMUtils, Utils);