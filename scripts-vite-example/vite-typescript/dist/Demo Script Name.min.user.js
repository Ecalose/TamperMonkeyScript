// ==UserScript==
// @name         Demo Script Name
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2024.10.28
// @author       WhiteSevs
// @description
// @license      GPL-3.0-only
// @icon
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://*/*
// @require      https://update.greasyfork.org/scripts/494167/1413255/CoverUMD.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.2.5/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@2.4.0/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.3.8/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/pops@1.8.0/dist/index.umd.js
// @connect      *
// @grant        GM_addStyle
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(d=>{if(typeof GM_addStyle=="function"){GM_addStyle(d);return}function t(n){let e=document.createElement("style");return e.innerHTML=n,document.head?document.head.appendChild(e):document.documentElement.appendChild(e),e}t(d)})(" html,body{padding:0;margin:0} ");

(function (V, P, y, S) {
	'use strict';

	var b=typeof GM_getValue<"u"?GM_getValue:void 0,C=typeof GM_info<"u"?GM_info:void 0,L=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,D=typeof GM_setValue<"u"?GM_setValue:void 0,N=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,O=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,_=typeof unsafeWindow<"u"?unsafeWindow:void 0,U=window;const W={$data:{get enable(){return r.getValue("httpx-use-cookie-enable")},get useDocumentCookie(){return r.getValue("httpx-use-document-cookie")},cookieRule:[]},fixCookieSplit(e){return g.isNotNull(e)&&!e.trim().endsWith(";")&&(e+=";"),e},concatCookie(e,t){return g.isNull(e)?t:(e=e.trim(),t=t.trim(),e=this.fixCookieSplit(e),t.startsWith(";")&&(t=t.substring(1)),e.concat(t))},handle(e){if(e.fetch||!this.$data.enable)return;let t="",n=e.url;n.startsWith("//")&&(n=window.location.protocol+n);let a=new URL(n);this.$data.useDocumentCookie&&a.hostname.endsWith(window.location.hostname.split(".").slice(-2).join("."))&&(t=this.concatCookie(t,document.cookie.trim()));for(let o=0;o<this.$data.cookieRule.length;o++){let l=this.$data.cookieRule[o];if(a.hostname.match(l.hostname)){let i=r.getValue(l.key);if(g.isNull(i))break;t=this.concatCookie(t,i);}}g.isNotNull(t)&&(e.headers&&e.headers.Cookie?e.headers.Cookie=this.concatCookie(e.headers.Cookie,t):e.headers.Cookie=t,m.info(["Httpx => 设置cookie:",e])),e.headers&&e.headers.Cookie!=null&&g.isNull(e.headers.Cookie)&&delete e.headers.Cookie;}},H="Demo Script Name",g=y.noConflict();P.noConflict();const j=S,m=new g.Log(C,_.console||U.console);var G;const I=((G=C==null?void 0:C.script)==null?void 0:G.name)||H,A=!1;m.config({debug:A,logMaxCount:1e3,autoClearConsole:!0,tag:!0});V.config(Object.defineProperties({html:!0,autoClose:!0,showClose:!1},{position:{get(){return r.getValue("qmsg-config-position","bottom")}},maxNums:{get(){return r.getValue("qmsg-config-maxnums",5)}},showReverse:{get(){return r.getValue("qmsg-config-showreverse",!0)}},zIndex:{get(){let e=y.getMaxZIndex(),t=S.config.InstanceUtils.getPopsMaxZIndex(e).zIndex;return y.getMaxValue(e,t)+100}}}));const q=new g.GM_Menu({GM_getValue:b,GM_setValue:D,GM_registerMenuCommand:L,GM_unregisterMenuCommand:N}),T=new g.Httpx(O);T.interceptors.request.use(e=>(W.handle(e),e));T.interceptors.response.use(void 0,e=>(m.error(["拦截器-请求错误",e]),e.type==="onabort"?V.warning("请求取消"):e.type==="onerror"?V.error("请求异常"):e.type==="ontimeout"?V.error("请求超时"):V.error("其它错误"),e));T.config({logDetails:A});_.Object.defineProperty,_.Function.prototype.apply,_.Function.prototype.call,_.Element.prototype.appendChild,_.setTimeout;g.addStyle.bind(g);const M="GM_Panel",B="data-init",w="data-key",$="data-default-value",K="data-init-more-value",v="data-storage-api",E=function(e,t,n,a,o,l){let i={text:e,type:"switch",description:o,attributes:{},props:{},getValue(){return !!this.props[v].get(t,n)},callback(u,s){let d=!!s;m.success(`${d?"开启":"关闭"} ${e}`),this.props[v].set(t,d);},afterAddToUListCallBack:l};return Reflect.set(i.attributes,w,t),Reflect.set(i.attributes,$,n),Reflect.set(i.props,v,{get(u,s){return r.getValue(u,s)},set(u,s){r.setValue(u,s);}}),i},R=function(e,t,n,a,o,l){let i=[];typeof a=="function"?i=a():i=a;let u={text:e,type:"select",description:l,attributes:{},props:{},getValue(){return this.props[v].get(t,n)},callback(s,d,h){let c=d;m.info(`选择：${h}`),this.props[v].set(t,c),typeof o=="function"&&o(s,c,h);},data:i};return Reflect.set(u.attributes,w,t),Reflect.set(u.attributes,$,n),Reflect.set(u.props,v,{get(s,d){return r.getValue(s,d)},set(s,d){r.setValue(s,d);}}),u},Z={id:"component-common",title:"通用",forms:[{text:"Toast配置",type:"forms",forms:[R("Toast位置","qmsg-config-position","bottom",[{value:"topleft",text:"左上角"},{value:"top",text:"顶部"},{value:"topright",text:"右上角"},{value:"left",text:"左边"},{value:"center",text:"中间"},{value:"right",text:"右边"},{value:"bottomleft",text:"左下角"},{value:"bottom",text:"底部"},{value:"bottomright",text:"右下角"}],(e,t,n)=>{m.info("设置当前Qmsg弹出位置"+n);},"Toast显示在页面九宫格的位置"),R("最多显示的数量","qmsg-config-maxnums",3,[{value:1,text:"1"},{value:2,text:"2"},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],void 0,"限制Toast显示的数量"),E("逆序弹出","qmsg-config-showreverse",!1,void 0,"修改Toast弹出的顺序")]},{text:"Cookie配置",type:"forms",forms:[E("启用","httpx-use-cookie-enable",!1,void 0,"启用后，将根据下面的配置进行添加cookie"),E("使用document.cookie","httpx-use-document-cookie",!1,void 0,"自动根据请求的域名来设置对应的cookie")]}]},r={$data:{__data:null,__oneSuccessExecMenu:null,__onceExec:null,__listenData:null,get data(){return r.$data.__data==null&&(r.$data.__data=new g.Dictionary),r.$data.__data},get oneSuccessExecMenu(){return r.$data.__oneSuccessExecMenu==null&&(r.$data.__oneSuccessExecMenu=new g.Dictionary),r.$data.__oneSuccessExecMenu},get onceExec(){return r.$data.__onceExec==null&&(r.$data.__onceExec=new g.Dictionary),r.$data.__onceExec},get scriptName(){return I},key:M,attributeKeyName:w,attributeDefaultValueName:$},$listener:{get listenData(){return r.$data.__listenData==null&&(r.$data.__listenData=new g.Dictionary),r.$data.__listenData}},init(){this.initPanelDefaultValue(),this.initExtensionsMenu();},isTopWindow(){return _.top===_.self},initExtensionsMenu(){this.isTopWindow()&&q.add([{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:!1,isStoreValue:!1,showText(e){return e},callback:()=>{this.showPanel();}}]);},initPanelDefaultValue(){let e=this;function t(o){if(!o.attributes)return;let l={},i=o.attributes[w];i!=null&&(l[i]=o.attributes[$]);let u=o.attributes[B];if(typeof u=="function"){let h=u();if(typeof h=="boolean"&&!h)return}let s=o.attributes[K];s&&typeof s=="object"&&Object.assign(l,s);let d=Object.keys(l);if(!d.length){m.warn(["请先配置键",o]);return}d.forEach(h=>{let c=l[h];e.$data.data.has(h)&&m.warn("请检查该key(已存在): "+h),e.$data.data.set(h,c);});}function n(o){for(let l=0;l<o.length;l++){let i=o[l];t(i);let u=i.forms;u&&Array.isArray(u)&&n(u);}}let a=this.getPanelContentConfig();for(let o=0;o<a.length;o++){let l=a[o];if(!l.forms)continue;let i=l.forms;i&&Array.isArray(i)&&n(i);}},setValue(e,t){let n=b(M,{}),a=n[e];n[e]=t,D(M,n),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,a,t);},getValue(e,t){let a=b(M,{})[e];return a??(this.$data.data.has(e)?this.$data.data.get(e):t)},deleteValue(e){let t=b(M,{}),n=t[e];Reflect.deleteProperty(t,e),D(M,t),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,n,void 0);},addValueChangeListener(e,t,n){let a=Math.random();return this.$listener.listenData.set(e,{id:a,key:e,callback:t}),n&&n.immediate&&t(e,this.getValue(e),this.getValue(e)),a},removeValueChangeListener(e){let t=null;for(const[n,a]of this.$listener.listenData.entries())if(a.id===e){t=n;break}typeof t=="string"?this.$listener.listenData.delete(t):console.warn("没有找到对应的监听器");},triggerMenuValueChange(e,t,n){if(this.$listener.listenData.has(e)){let a=this.$listener.listenData.get(e);if(typeof a.callback=="function"){let o=this.getValue(e),l=o,i=o;typeof t<"u"&&arguments.length>1&&(l=t),typeof n<"u"&&arguments.length>2&&(i=n),a.callback(e,i,l);}}},hasKey(e){let t=b(M,{});return e in t},execMenu(e,t,n=!1,a){if(!(typeof e=="string"||typeof e=="object"&&Array.isArray(e)))throw new TypeError("key 必须是字符串或者字符串数组");let o=[];typeof e=="object"&&Array.isArray(e)?o=[...e]:o.push(e);let l;for(let i=0;i<o.length;i++){const u=o[i];if(!this.$data.data.has(u)){m.warn(`${e} 键不存在`);return}let s=r.getValue(u);if(n&&(s=!s),typeof a=="function"){let d=a(u,s);typeof d=="boolean"&&(s=d);}if(!s)break;l=s;}l&&t(l);},execMenuOnce(e,t,n,a,o){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){m.warn(`${e} 键不存在`);return}if(this.$data.oneSuccessExecMenu.has(e))return;this.$data.oneSuccessExecMenu.set(e,1);let l=()=>{let c=r.getValue(e);return typeof n=="function"?n(e,c):c},i=[],u=c=>{let x=l(),f=[];if(c instanceof HTMLStyleElement?f=[c]:Array.isArray(c)&&(f=[...c.filter(p=>p!=null&&p instanceof HTMLStyleElement)]),x)i=i.concat(f);else for(let p=0;p<f.length;p++)f[p].remove(),f.splice(p,1),p--;},s=c=>typeof o=="function"?o(e,c):c,d=c=>{let x=[];if(s(c)){let f=t(c,u);f instanceof HTMLStyleElement?x=[f]:Array.isArray(f)&&(x=[...f.filter(p=>p!=null&&p instanceof HTMLStyleElement)]);}for(let f=0;f<i.length;f++)i[f].remove(),i.splice(f,1),f--;i=[...x];};this.addValueChangeListener(e,(c,x,f)=>{let p=f;typeof a=="function"&&(p=a(c,f,x)),d(p);});let h=l();h&&d(h);},execInheritMenuOnce(e,t,n,a){let o=this;const l=(i,u)=>{let s=o.getValue(i),d=o.getValue(u);if(typeof a=="function"){let h=a(s,d);if(h!=null)return h}return s};this.execMenuOnce(e,n,()=>l(e,t),()=>l(e,t)),this.execMenuOnce(t,()=>{},()=>!1,()=>(this.triggerMenuValueChange(e),!1));},onceExec(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExec.has(e)||(t(),this.$data.onceExec.set(e,1));},showPanel(){j.panel({title:{text:`${I}-设置`,position:"center",html:!1,style:""},content:this.getPanelContentConfig(),mask:{enable:!0,clickEvent:{toClose:!0,toHide:!1}},isMobile:this.isMobile(),width:this.getWidth(),height:this.getHeight(),drag:!0,only:!0});},isMobile(){return window.innerWidth<550},getWidth(){return window.innerWidth<550?"92vw":"550px"},getHeight(){return window.innerHeight>450?"80vh":"450px"},getPanelContentConfig(){return [Z]}};r.init();

})(Qmsg, DOMUtils, Utils, pops);