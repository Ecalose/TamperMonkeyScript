// ==UserScript==
// @name         Demo Script Name
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2024.8.30
// @author       WhiteSevs
// @description
// @license      GPL-3.0-only
// @icon
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://*/*
// @require      https://update.greasyfork.org/scripts/494167/1413255/CoverUMD.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.2.1/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@2.2.0/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.3.2/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/pops@1.5.2/dist/index.umd.js
// @connect      *
// @grant        GM_addStyle
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(d=>{if(typeof GM_addStyle=="function"){GM_addStyle(d);return}function t(n){let e=document.createElement("style");return e.innerHTML=n,document.head?document.head.appendChild(e):document.documentElement.appendChild(e),e}t(d)})(" html,body{padding:0;margin:0} ");

(function (x, A, w, I) {
	'use strict';

	var M=typeof GM_getValue<"u"?GM_getValue:void 0,v=typeof GM_info<"u"?GM_info:void 0,S=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,$=typeof GM_setValue<"u"?GM_setValue:void 0,L=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,P=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,p=typeof unsafeWindow<"u"?unsafeWindow:void 0,R=window;const N={$data:{get enable(){return s.getValue("httpx-use-cookie-enable")},get useDocumentCookie(){return s.getValue("httpx-use-document-cookie")},cookieRule:[]},fixCookieSplit(e){return h.isNotNull(e)&&!e.trim().endsWith(";")&&(e+=";"),e},concatCookie(e,t){return h.isNull(e)?t:(e=e.trim(),t=t.trim(),e=this.fixCookieSplit(e),t.startsWith(";")&&(t=t.substring(1)),e.concat(t))},handle(e){if(e.fetch||!this.$data.enable)return;let t="",i=e.url;i.startsWith("//")&&(i=window.location.protocol+i);let o=new URL(i);this.$data.useDocumentCookie&&o.hostname.endsWith(window.location.hostname.split(".").slice(-2).join("."))&&(t=this.concatCookie(t,document.cookie.trim()));for(let a=0;a<this.$data.cookieRule.length;a++){let n=this.$data.cookieRule[a];if(o.hostname.match(n.hostname)){let l=s.getValue(n.key);if(h.isNull(l))break;t=this.concatCookie(t,l);}}h.isNotNull(t)&&(e.headers&&e.headers.Cookie?e.headers.Cookie=this.concatCookie(e.headers.Cookie,t):e.headers.Cookie=t,m.info(["Httpx => 设置cookie:",e])),e.headers&&e.headers.Cookie!=null&&h.isNull(e.headers.Cookie)&&delete e.headers.Cookie;}},U="Demo Script Name",h=w.noConflict();A.noConflict();const W=I,m=new h.Log(v,p.console||R.console);var T;const y=((T=v==null?void 0:v.script)==null?void 0:T.name)||U,G=!1;m.config({debug:G,logMaxCount:1e3,autoClearConsole:!0,tag:!0});x.config(Object.defineProperties({html:!0,autoClose:!0,showClose:!1},{position:{get(){return s.getValue("qmsg-config-position","bottom")}},maxNums:{get(){return s.getValue("qmsg-config-maxnums",5)}},showReverse:{get(){return s.getValue("qmsg-config-showreverse",!0)}},zIndex:{get(){let e=w.getMaxZIndex(),t=I.config.InstanceUtils.getPopsMaxZIndex(e).zIndex;return w.getMaxValue(e,t)+100}}}));const O=new h.GM_Menu({GM_getValue:M,GM_setValue:$,GM_registerMenuCommand:S,GM_unregisterMenuCommand:L}),E=new h.Httpx(P);E.interceptors.request.use(e=>(N.handle(e),e));E.interceptors.response.use(void 0,e=>(m.error(["拦截器-请求错误",e]),e.type==="onabort"?x.warning("请求取消"):e.type==="onerror"?x.error("请求异常"):e.type==="ontimeout"?x.error("请求超时"):x.error("其它错误"),e));E.config({logDetails:G});p.Object.defineProperty,p.Function.prototype.apply,p.Function.prototype.call,p.Element.prototype.appendChild,p.setTimeout;h.addStyle.bind(h);const _="GM_Panel",B="data-init",b="data-key",V="data-default-value",H="data-init-more-value",C=function(e,t,i,o,a){let n={text:e,type:"switch",description:a,attributes:{},getValue(){return !!s.getValue(t,i)},callback(l,r){m.success(`${r?"开启":"关闭"} ${e}`),s.setValue(t,!!r);},afterAddToUListCallBack:void 0};return n.attributes&&(n.attributes[b]=t,n.attributes[V]=!!i),n},D=function(e,t,i,o,a,n){let l=[];typeof o=="function"?l=o():l=o;let r={text:e,type:"select",description:n,attributes:{},getValue(){return s.getValue(t,i)},callback(g,c,f){s.setValue(t,c),typeof a=="function"&&a(g,c,f);},data:l};return r.attributes&&(r.attributes[b]=t,r.attributes[V]=i),r},j={id:"component-common",title:"通用",forms:[{text:"Toast配置",type:"forms",forms:[D("Toast位置","qmsg-config-position","bottom",[{value:"topleft",text:"左上角"},{value:"top",text:"顶部"},{value:"topright",text:"右上角"},{value:"left",text:"左边"},{value:"center",text:"中间"},{value:"right",text:"右边"},{value:"bottomleft",text:"左下角"},{value:"bottom",text:"底部"},{value:"bottomright",text:"右下角"}],(e,t,i)=>{m.info("设置当前Qmsg弹出位置"+i);},"Toast显示在页面九宫格的位置"),D("最多显示的数量","qmsg-config-maxnums",3,[{value:1,text:"1"},{value:2,text:"2"},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],void 0,"限制Toast显示的数量"),C("逆序弹出","qmsg-config-showreverse",!1,void 0,"修改Toast弹出的顺序")]},{text:"Cookie配置",type:"forms",forms:[C("启用","httpx-use-cookie-enable",!1,void 0,"启用后，将根据下面的配置进行添加cookie"),C("使用document.cookie","httpx-use-document-cookie",!1,void 0,"自动根据请求的域名来设置对应的cookie")]}]},s={$data:{__data:null,__oneSuccessExecMenu:null,__onceExec:null,__listenData:null,get data(){return s.$data.__data==null&&(s.$data.__data=new h.Dictionary),s.$data.__data},get oneSuccessExecMenu(){return s.$data.__oneSuccessExecMenu==null&&(s.$data.__oneSuccessExecMenu=new h.Dictionary),s.$data.__oneSuccessExecMenu},get onceExec(){return s.$data.__onceExec==null&&(s.$data.__onceExec=new h.Dictionary),s.$data.__onceExec},get scriptName(){return y},key:_,attributeKeyName:b,attributeDefaultValueName:V},$listener:{get listenData(){return s.$data.__listenData==null&&(s.$data.__listenData=new h.Dictionary),s.$data.__listenData}},init(){this.initPanelDefaultValue(),this.initExtensionsMenu();},isTopWindow(){return p.top===p.self},initExtensionsMenu(){this.isTopWindow()&&O.add([{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:!1,isStoreValue:!1,showText(e){return e},callback:()=>{this.showPanel();}}]);},initPanelDefaultValue(){let e=this;function t(a){if(!a.attributes)return;let n={},l=a.attributes[b];l!=null&&(n[l]=a.attributes[V]);let r=a.attributes[B];if(typeof r=="function"){let f=r();if(typeof f=="boolean"&&!f)return}let g=a.attributes[H];g&&typeof g=="object"&&Object.assign(n,g);let c=Object.keys(n);if(!c.length){m.warn(["请先配置键",a]);return}c.forEach(f=>{let u=n[f];e.$data.data.has(f)&&m.warn("请检查该key(已存在): "+f),e.$data.data.set(f,u);});}function i(a){for(let n=0;n<a.length;n++){let l=a[n];t(l);let r=l.forms;r&&Array.isArray(r)&&i(r);}}let o=this.getPanelContentConfig();for(let a=0;a<o.length;a++){let n=o[a];if(!n.forms)continue;let l=n.forms;l&&Array.isArray(l)&&i(l);}},setValue(e,t){let i=M(_,{}),o=i[e];i[e]=t,$(_,i),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,o,t);},getValue(e,t){let o=M(_,{})[e];return o??(this.$data.data.has(e)?this.$data.data.get(e):t)},deleteValue(e){let t=M(_,{}),i=t[e];Reflect.deleteProperty(t,e),$(_,t),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,i,void 0);},addValueChangeListener(e,t,i){let o=Math.random();return this.$listener.listenData.set(e,{id:o,key:e,callback:t}),i&&i.immediate&&t(e,this.getValue(e),this.getValue(e)),o},removeValueChangeListener(e){let t=null;for(const[i,o]of this.$listener.listenData.entries())if(o.id===e){t=i;break}typeof t=="string"?this.$listener.listenData.delete(t):console.warn("没有找到对应的监听器");},triggerMenuValueChange(e,t,i){if(this.$listener.listenData.has(e)){let o=this.$listener.listenData.get(e);if(typeof o.callback=="function"){let a=this.getValue(e),n=a,l=a;typeof t<"u"&&arguments.length>1&&(n=t),typeof i<"u"&&arguments.length>2&&(l=i),o.callback(e,l,n);}}},hasKey(e){let t=M(_,{});return e in t},execMenu(e,t,i=!1){if(!(typeof e=="string"||typeof e=="object"&&Array.isArray(e)))throw new TypeError("key 必须是字符串或者字符串数组");let o=[];typeof e=="object"&&Array.isArray(e)?o=[...e]:o.push(e);let a;for(let n=0;n<o.length;n++){const l=o[n];if(!this.$data.data.has(l)){m.warn(`${e} 键不存在`);return}let r=s.getValue(l);if(i&&(r=!r),!r)break;a=r;}a&&t(a);},execMenuOnce(e,t,i,o){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){m.warn(`${e} 键不存在`);return}if(this.$data.oneSuccessExecMenu.has(e))return;this.$data.oneSuccessExecMenu.set(e,1);let a=()=>{let c=s.getValue(e);return typeof i=="function"?i(e,c):c},n=[],l=c=>{let f=a(),u=[];if(c instanceof HTMLStyleElement?u=[c]:Array.isArray(c)&&(u=[...c.filter(d=>d!=null&&d instanceof HTMLStyleElement)]),f)n=n.concat(u);else for(let d=0;d<u.length;d++)u[d].remove(),u.splice(d,1),d--;},r=c=>{let f=[];if(c){let u=t(c,l);u instanceof HTMLStyleElement?f=[u]:Array.isArray(u)&&(f=[...u.filter(d=>d!=null&&d instanceof HTMLStyleElement)]);}for(let u=0;u<n.length;u++)n[u].remove(),n.splice(u,1),u--;n=[...f];};this.addValueChangeListener(e,(c,f,u)=>{let d=u;typeof o=="function"&&(d=o(c,u,f)),r(d);});let g=a();g&&r(g);},execInheritMenuOnce(e,t,i,o){let a=this;const n=(l,r)=>{let g=a.getValue(l),c=a.getValue(r);if(typeof o=="function"){let f=o(g,c);if(f!==void 0)return f}return g};this.execMenuOnce(e,i,()=>n(e,t),()=>n(e,t)),this.execMenuOnce(t,()=>{},()=>!1,()=>(this.triggerMenuValueChange(e),!1));},onceExec(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExec.has(e)||(t(),this.$data.onceExec.set(e,1));},showPanel(){W.panel({title:{text:`${y}-设置`,position:"center",html:!1,style:""},content:this.getPanelContentConfig(),mask:{enable:!0,clickEvent:{toClose:!0,toHide:!1}},isMobile:this.isMobile(),width:this.getWidth(),height:this.getHeight(),drag:!0,only:!0});},isMobile(){return window.innerWidth<550},getWidth(){return window.innerWidth<550?"92vw":"550px"},getHeight(){return window.innerHeight>450?"80vh":"450px"},getPanelContentConfig(){return [j]}};s.init();

})(Qmsg, DOMUtils, Utils, pops);