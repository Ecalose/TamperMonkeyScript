// ==UserScript==
// @name         ImageViewer
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2025.10.2
// @author       WhiteSevs
// @description  ViewerÁúãÂõæÂ∑•ÂÖ∑ÔºåÊîØÊåÅÂõæÁâáÁøªËΩ¨„ÄÅÊóãËΩ¨„ÄÅÁº©Êîæ
// @license      GPL-3.0-only
// @icon         data:image/png;base64,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
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://*/*
// @require      https://fastly.jsdelivr.net/gh/WhiteSevs/TamperMonkeyScript@86be74b83fca4fa47521cded28377b35e1d7d2ac/lib/CoverUMD/index.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@2.9.0/dist/index.umd.min.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.7.0/dist/index.umd.min.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/pops@2.5.4/dist/index.umd.min.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.5.0/dist/index.umd.min.js
// @require      https://fastly.jsdelivr.net/npm/viewerjs@1.11.7/dist/viewer.min.js
// @resource     ViewerCSS  https://fastly.jsdelivr.net/npm/viewerjs@1.11.7/dist/viewer.min.css
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(function (L, V, S, H, fe) {
	'use strict';

	var he=typeof GM_deleteValue<"u"?GM_deleteValue:void 0,ne=typeof GM_getResourceText<"u"?GM_getResourceText:void 0,ie=typeof GM_getValue<"u"?GM_getValue:void 0,B=typeof GM_info<"u"?GM_info:void 0,pe=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,oe=typeof GM_setValue<"u"?GM_setValue:void 0,ge=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,me=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,R=typeof unsafeWindow<"u"?unsafeWindow:void 0,Ce=window;const le={waitRemove(...e){e.forEach(t=>{typeof t=="string"&&V.waitNodeList(t).then(n=>{n.forEach(a=>a.remove());});});},createBlockCSSNode(...e){let t=[];if(e.length!==0&&!(e.length===1&&typeof e[0]=="string"&&e[0].trim()===""))return e.forEach(n=>{Array.isArray(n)?t=t.concat(n):t.push(n);}),V.createElement("style",{type:"text/css",innerHTML:`${t.join(`,
`)}{display: none !important;}`})},addBlockCSS(...e){let t=[];if(e.length!==0&&!(e.length===1&&typeof e[0]=="string"&&e[0].trim()===""))return e.forEach(n=>{Array.isArray(n)?t=t.concat(n):t.push(n);}),re(`${t.join(`,
`)}{display: none !important;}`)},setGMResourceCSS(e){let t=typeof ne=="function"?ne(e.keyName):null;typeof t=="string"&&t?re(t):le.loadStyleLink(e.url);},async loadStyleLink(e){let t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,V.ready(()=>{document.head.appendChild(t);});},async loadScript(e){let t=document.createElement("script");return t.src=e,new Promise(n=>{t.onload=()=>{n(null);},(document.head||document.documentElement).appendChild(t);})},fixUrl(e){return e=e.trim(),e.startsWith("data:")||e.match(/^http(s|):\/\//i)?e:e.startsWith("//")?(e.startsWith("///")||(e=window.location.protocol+e),e):(e.startsWith("/")||(e+="/"),e=window.location.origin+e,e)},fixHttps(e){if(e.startsWith("https://")||!e.startsWith("http://"))return e;try{let t=new URL(e);return t.protocol="https:",t.toString()}catch{return e}},lockScroll(...e){let t=document.createElement("style");t.innerHTML=`
			.pops-overflow-hidden-important {
				overflow: hidden !important;
			}
		`;let n=[document.documentElement,document.body].concat(...e||[]);return n.forEach(a=>{a.classList.add("pops-overflow-hidden-important");}),(document.head||document.documentElement).appendChild(t),{recovery(){n.forEach(a=>{a.classList.remove("pops-overflow-hidden-important");}),t.remove();}}},async getClipboardText(){function e(a){navigator.clipboard.readText().then(r=>{a(r);}).catch(r=>{x.error("ËØªÂèñÂâ™Ë¥¥ÊùøÂÜÖÂÆπÂ§±Ë¥•üëâ",r),a("");});}function t(a){navigator.permissions.query({name:"clipboard-read"}).then(r=>{e(a);}).catch(r=>{x.error("Áî≥ËØ∑Ââ™Ë¥¥ÊùøÊùÉÈôêÂ§±Ë¥•ÔºåÂ∞ùËØïÁõ¥Êé•ËØªÂèñüëâ",r.message??r.name??r.stack),e(a);});}function n(){return !(typeof navigator?.clipboard?.readText!="function"||typeof navigator?.permissions?.query!="function")}return new Promise(a=>{if(!n()){a("");return}document.hasFocus()?t(a):window.addEventListener("focus",()=>{t(a);},{once:true});})},escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/¬©/g,"&copy;").replace(/¬Æ/g,"&reg;").replace(/‚Ñ¢/g,"&trade;").replace(/‚Üí/g,"&rarr;").replace(/‚Üê/g,"&larr;").replace(/‚Üë/g,"&uarr;").replace(/‚Üì/g,"&darr;").replace(/‚Äî/g,"&mdash;").replace(/‚Äì/g,"&ndash;").replace(/‚Ä¶/g,"&hellip;").replace(/ /g,"&nbsp;").replace(/\r\n/g,"<br>").replace(/\r/g,"<br>").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;")},interval(e,t,n=5e3){let a,r=n-t,o=t,i=async d=>{let l=await e(d);if(typeof l=="boolean"&&!l||d){p.workerClearTimeout(a);return}if(o+=t,o>r){i(true);return}a=p.workerSetTimeout(()=>{i(false);},t);};i(false);},findParentNode(e,t,n){if(n){let a=V.closest(e,n);if(a)return a.querySelector(t)}else return V.matches(e,t)?e:V.closest(e,t)}},P={qmsg_config_position:{key:"qmsg-config-position",defaultValue:"bottom"},qmsg_config_maxnums:{key:"qmsg-config-maxnums",defaultValue:3},qmsg_config_showreverse:{key:"qmsg-config-showreverse",defaultValue:false}},p=S.noConflict(),g=V.noConflict(),W=H,x=new p.Log(B,R.console||Ce.console);let ae=B?.script?.name||void 0;H.config.Utils.AnyTouch();const ye=false;x.config({debug:false,logMaxCount:250,autoClearConsole:true,tag:true});L.config({isHTML:true,autoClose:true,showClose:false,consoleLogContent(e){const t=e.getSetting().type;if(t==="loading")return  false;const n=e.getSetting().content;return t==="warning"?x.warn(n):t==="error"?x.error(n):x.info(n),true},get position(){return b.getValue(P.qmsg_config_position.key,P.qmsg_config_position.defaultValue)},get maxNums(){return b.getValue(P.qmsg_config_maxnums.key,P.qmsg_config_maxnums.defaultValue)},get showReverse(){return b.getValue(P.qmsg_config_showreverse.key,P.qmsg_config_showreverse.defaultValue)},get zIndex(){let e=S.getMaxZIndex(),t=H.config.InstanceUtils.getPopsMaxZIndex().zIndex;return S.getMaxValue(e,t)+100}});W.GlobalConfig.setGlobalConfig({zIndex:()=>{let e=S.getMaxZIndex(void 0,void 0,n=>{if(n?.classList?.contains("qmsg-shadow-container")||n?.closest("qmsg")&&n.getRootNode()instanceof ShadowRoot)return  false}),t=H.config.InstanceUtils.getPopsMaxZIndex().zIndex;return S.getMaxValue(e,t)+100},mask:{enable:true,clickEvent:{toClose:false,toHide:false}},drag:true});const _e=new p.GM_Menu({GM_getValue:ie,GM_setValue:oe,GM_registerMenuCommand:pe,GM_unregisterMenuCommand:ge}),se=new p.Httpx({xmlHttpRequest:me,logDetails:ye});se.interceptors.request.use(e=>e);se.interceptors.response.use(void 0,e=>(x.error("Êã¶Êà™Âô®-ËØ∑Ê±ÇÈîôËØØ",e),e.type==="onabort"?L.warning("ËØ∑Ê±ÇÂèñÊ∂à",{consoleLogContent:true}):e.type==="onerror"?L.error("ËØ∑Ê±ÇÂºÇÂ∏∏",{consoleLogContent:true}):e.type==="ontimeout"?L.error("ËØ∑Ê±ÇË∂ÖÊó∂",{consoleLogContent:true}):L.error("ÂÖ∂ÂÆÉÈîôËØØ",{consoleLogContent:true}),e));R.Object.defineProperty,R.Function.prototype.apply,R.Function.prototype.call,R.Element.prototype.appendChild,R.setTimeout;const re=g.addStyle.bind(g),xe=V.selector.bind(V),we=V.selectorAll.bind(V);new p.GM_Cookie;const ue="GM_Panel",ve="data-init",J="data-key",Q="data-default-value",Ee="data-init-more-value",Y="data-storage-api",F={get width(){return globalThis.innerWidth},get height(){return globalThis.innerHeight}},Z={setting:{get width(){return F.width<550?"88vw":F.width<700?"550px":"700px"},get height(){return F.height<450?"70vh":F.height<550?"450px":"550px"}},settingMiddle:{get width(){return F.width<350?"88vw":"350px"}}};class ce{storageKey;listenerData;constructor(t){if(typeof t=="string"){let n=t.trim();if(n=="")throw new Error("keyÂèÇÊï∞‰∏çËÉΩ‰∏∫Á©∫Â≠óÁ¨¶‰∏≤");this.storageKey=n;}else throw new Error("keyÂèÇÊï∞Á±ªÂûãÈîôËØØÔºåÂøÖÈ°ªÊòØÂ≠óÁ¨¶‰∏≤");this.listenerData=new S.Dictionary;}getLocalValue(){let t=ie(this.storageKey);return t==null&&(t={},this.setLocalValue(t)),t}setLocalValue(t){oe(this.storageKey,t);}set(t,n){let a=this.get(t),r=this.getLocalValue();Reflect.set(r,t,n),this.setLocalValue(r),this.triggerValueChangeListener(t,a,n);}get(t,n){let a=this.getLocalValue();return Reflect.get(a,t)??n}getAll(){return this.getLocalValue()}delete(t){let n=this.get(t),a=this.getLocalValue();Reflect.deleteProperty(a,t),this.setLocalValue(a),this.triggerValueChangeListener(t,n,void 0);}has(t){let n=this.getLocalValue();return Reflect.has(n,t)}keys(){let t=this.getLocalValue();return Reflect.ownKeys(t)}values(){let t=this.getLocalValue();return Reflect.ownKeys(t).map(n=>Reflect.get(t,n))}clear(){he(this.storageKey);}addValueChangeListener(t,n){let a=Math.random(),r=this.listenerData.get(t)||[];return r.push({id:a,key:t,callback:n}),this.listenerData.set(t,r),a}removeValueChangeListener(t){let n=false;for(const[a,r]of this.listenerData.entries()){for(let o=0;o<r.length;o++){const i=r[o];(typeof t=="string"&&i.key===t||typeof t=="number"&&i.id===t)&&(r.splice(o,1),o--,n=true);}this.listenerData.set(a,r);}return n}triggerValueChangeListener(t,n,a){if(!this.listenerData.has(t))return;let r=this.listenerData.get(t);for(let o=0;o<r.length;o++){const i=r[o];if(typeof i.callback=="function"){let d=this.get(t),l,s;typeof n<"u"&&arguments.length>=2?s=n:s=d,typeof a<"u"&&arguments.length>2?l=a:l=d,i.callback(t,s,l);}}}}const D=new ce(ue),K={$data:{__contentConfig:null,get contentConfig(){return this.__contentConfig==null&&(this.__contentConfig=new p.Dictionary),this.__contentConfig},__defaultBottomContentConfig:[]},addContentConfig(e){Array.isArray(e)||(e=[e]);let t=this.$data.contentConfig.keys().length;this.$data.contentConfig.set(t,e);},getAllContentConfig(){return this.$data.contentConfig.values().flat()},getConfig(e=0){return this.$data.contentConfig.get(e)??[]},getDefaultBottomContentConfig(){return this.$data.__defaultBottomContentConfig.length?this.$data.__defaultBottomContentConfig:[{id:"script-version",title:`ÁâàÊú¨Ôºö${B?.script?.version||"Êú™Áü•"}`,isBottom:true,forms:[],clickFirstCallback(e,t,n){let a=B?.script?.supportURL||B?.script?.namespace;return typeof a=="string"&&p.isNotNull(a)&&window.open(a,"_blank"),false}}]},setDefaultBottomContentConfig(e){this.$data.__defaultBottomContentConfig=e;}},Me={$data:{__menuOption:[{key:"show_pops_panel_setting",text:"‚öô ËÆæÁΩÆ",autoReload:false,isStoreValue:false,showText(e){return e},callback:()=>{b.showPanel(K.getConfig(0));}}],get menuOption(){return this.__menuOption}},init(){this.initExtensionsMenu();},initExtensionsMenu(){b.isTopWindow()&&_e.add(this.$data.menuOption);},addMenuOption(e){Array.isArray(e)||(e=[e]),this.$data.menuOption.push(...e);},updateMenuOption(e){Array.isArray(e)||(e=[e]),e.forEach(t=>{let n=this.$data.menuOption.findIndex(a=>a.key===t.key);n!==-1&&(this.$data.menuOption[n]=t);});},getMenuOption(e=0){return this.$data.menuOption[e]},deleteMenuOption(e=0){this.$data.menuOption.splice(e,1);}},b={$data:{__contentConfigInitDefaultValue:null,__onceExecMenuData:null,__urlChangeReloadMenuExecOnce:null,__onceExecData:null,__panelConfig:{},$panel:null,panelContent:[],get contentConfigInitDefaultValue(){return this.__contentConfigInitDefaultValue==null&&(this.__contentConfigInitDefaultValue=new p.Dictionary),this.__contentConfigInitDefaultValue},contentConfigInitDisabledKeys:[],get onceExecMenuData(){return this.__onceExecMenuData==null&&(this.__onceExecMenuData=new p.Dictionary),this.__onceExecMenuData},get urlChangeReloadMenuExecOnce(){return this.__urlChangeReloadMenuExecOnce==null&&(this.__urlChangeReloadMenuExecOnce=new p.Dictionary),this.__urlChangeReloadMenuExecOnce},get onceExecData(){return this.__onceExecData==null&&(this.__onceExecData=new p.Dictionary),this.__onceExecData},get scriptName(){return ae},get panelConfig(){return this.__panelConfig},set panelConfig(e){this.__panelConfig=e;},key:ue,attributeKeyName:J,attributeDefaultValueName:Q},init(){this.initContentDefaultValue(),Me.init();},isTopWindow(){return R.top===R.self},initContentDefaultValue(){const e=a=>{if(!a.attributes||a.type==="button"||a.type==="forms"||a.type==="deepMenu")return;const r=a.attributes;let o=r[ve];if(typeof o=="function"){let s=o();if(typeof s=="boolean"&&!s)return}let i=new Map,d=r[J];if(d!=null){const s=r[Q];i.set(d,s);}let l=r[Ee];if(typeof l=="object"&&l&&Object.keys(l).forEach(s=>{i.set(s,l[s]);}),!i.size){x.warn(["ËØ∑ÂÖàÈÖçÁΩÆÈîÆ",a]);return}if(a.type==="switch"){let s=typeof a.disabled=="function"?a.disabled():a.disabled;typeof s=="boolean"&&s&&this.$data.contentConfigInitDisabledKeys.push(...i.keys());}for(const[s,u]of i.entries())this.setDefaultValue(s,u);},t=a=>{for(let r=0;r<a.length;r++){let o=a[r];e(o);let i=o.forms;i&&Array.isArray(i)&&t(i);}},n=[...K.getAllContentConfig()];for(let a=0;a<n.length;a++){let r=n[a];if(!r.forms)continue;const o=r.forms;o&&Array.isArray(o)&&t(o);}this.$data.contentConfigInitDisabledKeys=[...new Set(this.$data.contentConfigInitDisabledKeys)];},setDefaultValue(e,t){this.$data.contentConfigInitDefaultValue.has(e)&&x.warn("ËØ∑Ê£ÄÊü•ËØ•key(Â∑≤Â≠òÂú®): "+e),this.$data.contentConfigInitDefaultValue.set(e,t);},getDefaultValue(e){return this.$data.contentConfigInitDefaultValue.get(e)},setValue(e,t){D.set(e,t);},getValue(e,t){let n=D.get(e);return n??(this.$data.contentConfigInitDefaultValue.has(e)?this.$data.contentConfigInitDefaultValue.get(e):t)},deleteValue(e){D.delete(e);},hasKey(e){return D.has(e)},addValueChangeListener(e,t){return D.addValueChangeListener(e,(a,r,o)=>{t(e,o,r);})},removeValueChangeListener(e){D.removeValueChangeListener(e);},triggerMenuValueChange(e,t,n){D.triggerValueChangeListener(e,n,t);},exec(e,t,n,a=true){const r=this;let o;typeof e=="string"||Array.isArray(e)?o=()=>e:o=e;let i=false,d=o(),l=[];Array.isArray(d)?(i=true,l=d):l.push(d);let s=l.find(c=>!this.$data.contentConfigInitDefaultValue.has(c));if(s){x.warn(`${s} ÈîÆ‰∏çÂ≠òÂú®`);return}let u=JSON.stringify(l);if(a&&this.$data.onceExecMenuData.has(u))return this.$data.onceExecMenuData.get(u);let h=[],_=[],I=(c,C)=>{let v=[];Array.isArray(C)||(C=[C]),C.forEach(M=>{if(M!=null&&M instanceof HTMLStyleElement){v.push(M);return}}),h=h.concat(v);},k=c=>this.getValue(c),U=()=>{for(let c=0;c<h.length;c++)h[c].remove(),h.splice(c,1),c--;},z=()=>{let c=false;return typeof n=="function"?c=n(l):c=l.every(C=>k(C)),c},G=c=>{let C=z(),v=[];if(C){let M=l.map(f=>this.getValue(f)),m=t({value:i?M:M[0],addStyleElement:(...f)=>I(true,...f)});Array.isArray(m)||(m=[m]),m.forEach(f=>{if(f!=null&&f instanceof HTMLStyleElement){v.push(f);return}});}U(),h=[...v];};a&&l.forEach(c=>{let C=this.addValueChangeListener(c,(v,M,m)=>{G();});_.push(C);}),G();let E={reload(){G();},clear(){this.clearStoreStyleElements(),this.removeValueChangeListener(),a&&r.$data.onceExecMenuData.delete(u);},clearStoreStyleElements:()=>U(),removeValueChangeListener:()=>{_.forEach(c=>{this.removeValueChangeListener(c);});}};return this.$data.onceExecMenuData.set(u,E),E},execMenu(e,t,n=false,a=false){return this.exec(e,r=>t(r),r=>r.every(i=>{let d=!!this.getValue(i);return b.$data.contentConfigInitDisabledKeys.includes(i)&&(d=false,x.warn(`.execMenu${a?"Once":""} ${i} Ë¢´Á¶ÅÁî®`)),n&&(d=!d),d}),a)},execMenuOnce(e,t,n=false,a=false){const r=this.execMenu(e,t,n,true);if(a&&r){const o=()=>{r.reload();};this.removeUrlChangeWithExecMenuOnceListener(e),this.addUrlChangeWithExecMenuOnceListener(e,o);const i=r.clear;r.clear=()=>{i(),this.removeUrlChangeWithExecMenuOnceListener(e);};}return r},deleteExecMenuOnce(e){return e=this.transformKey(e),this.$data.onceExecMenuData.delete(e),this.$data.urlChangeReloadMenuExecOnce.delete(e),D.removeValueChangeListener(e)},onceExec(e,t){if(e=this.transformKey(e),typeof e!="string")throw new TypeError("key ÂøÖÈ°ªÊòØÂ≠óÁ¨¶‰∏≤");this.$data.onceExecData.has(e)||(t(),this.$data.onceExecData.set(e,1));},deleteOnceExec(e){e=this.transformKey(e),this.$data.onceExecData.delete(e);},addUrlChangeWithExecMenuOnceListener(e,t){e=this.transformKey(e),this.$data.urlChangeReloadMenuExecOnce.set(e,t);},removeUrlChangeWithExecMenuOnceListener(e){e=this.transformKey(e),this.$data.urlChangeReloadMenuExecOnce.delete(e);},triggerUrlChangeWithExecMenuOnceEvent(e){this.$data.urlChangeReloadMenuExecOnce.forEach((t,n)=>{t(e);});},showPanel(e,t=`${ae}-ËÆæÁΩÆ`,n=false,a=false){this.$data.$panel=null,this.$data.panelContent=[];let r=e.findIndex(i=>(typeof i.isBottom=="function"?i.isBottom():!!i.isBottom)&&i.id==="script-version")!==-1;!n&&!r&&e.push(...K.getDefaultBottomContentConfig());let o=W.panel({title:{text:t,position:"center",html:false,style:""},content:e,btn:{close:{enable:true,callback:(i,d)=>{i.close(),this.$data.$panel=null;}}},mask:{enable:true,clickEvent:{toClose:true,toHide:false},clickCallBack:(i,d)=>{i(),this.$data.$panel=null;}},width:Z.setting.width,height:Z.setting.height,drag:true,only:true,...this.$data.panelConfig});this.$data.$panel=o,this.$data.panelContent=e,a||this.registerConfigSearch({$panel:o,content:e});},registerConfigSearch(e){const{$panel:t,content:n}=e;let a=async(u,h)=>{if(u==null)return;let _=await h(u);return _&&typeof _.isFind=="boolean"&&_.isFind?_.data:await a(_.data,h)},r=(u,h)=>{const _=new IntersectionObserver(I=>{I.forEach(k=>{k.isIntersecting&&(h?.(),_.disconnect());});},{root:null,threshold:1});_.observe(u),u.scrollIntoView({behavior:"smooth",block:"center"});},o=u=>{const h="pops-flashing";g.animationend(u,()=>{u.classList.remove(h);}),u.classList.add(h);},i=(u,h)=>{g.preventEvent(u);let _=W.alert({title:{text:"ÊêúÁ¥¢ÈÖçÁΩÆ",position:"center"},content:{text:`
						<div class="search-wrapper">
							<input class="search-config-text" name="search-config" type="text" placeholder="ËØ∑ËæìÂÖ•ÈúÄË¶ÅÊêúÁ¥†ÁöÑÈÖçÁΩÆÂêçÁß∞">
						</div>
						<div class="search-result-wrapper"></div>
					`,html:true},btn:{ok:{enable:false}},mask:{clickEvent:{toClose:true}},width:Z.settingMiddle.width,height:"auto",drag:true,style:`
					${W.config.cssText.panelCSS}

					.search-wrapper{
						border-bottom: 1px solid rgb(235, 238, 245, 1);
					}
					.pops-content:has(.search-result-wrapper:empty) .search-wrapper{
						border-bottom: 0;
					}
					.search-config-text{
						width: 100%;
						border: 0;
						height: 32px;
						padding: 0px 10px;
						outline: none;
					}
					.search-result-wrapper{
						max-height: 400px;
						overflow: auto;
					}
					.search-result-item{
						cursor: pointer;
						padding: 5px 10px;
						display: flex;
						flex-direction: column;
					}
					.search-result-item:hover{
						background-color: #D8F1FD;
					}
					.search-result-item-path{
						display: flex;
    					align-items: center;
					}
					.search-result-item-description{
						font-size: 0.8em;
						color: #6c6c6c;
					}
					${e.searchDialogStyle??""}
				`});_.$shadowRoot.querySelector(".search-wrapper");let I=_.$shadowRoot.querySelector(".search-config-text"),k=_.$shadowRoot.querySelector(".search-result-wrapper");I.focus();let U=()=>{g.empty(k);},z=E=>{const c=p.queryProperty(E,v=>v?.next?{isFind:false,data:v.next}:{isFind:true,data:v});let C=g.createElement("div",{className:"search-result-item",innerHTML:`
							<div class="search-result-item-path">${c.matchedData?.path}</div>
							<div class="search-result-item-description">${c.matchedData?.description??""}</div>
						`});return g.on(C,"click",v=>{let m=t.$shadowRoot.querySelectorAll("aside.pops-panel-aside .pops-panel-aside-top-container li")[E.index];if(!m){L.error(`Â∑¶‰æßÈ°π‰∏ãÊ†á${E.index}‰∏çÂ≠òÂú®`);return}m.scrollIntoView({behavior:"smooth",block:"center"}),m.click(),a(E.next,async f=>{if(f?.next){let w=await g.waitNode(()=>Array.from(t.$shadowRoot.querySelectorAll(".pops-panel-deepMenu-nav-item")).find(y=>{const $=Reflect.get(y,"__formConfig__");return typeof $=="object"&&$!=null&&$.text===f.name}),2500);if(w)w.click();else return L.error("Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑ‰∫åÁ∫ßËèúÂçï"),{isFind:true,data:f};return {isFind:false,data:f.next}}else {let w=await g.waitNode(()=>Array.from(t.$shadowRoot.querySelectorAll("li:not(.pops-panel-deepMenu-nav-item)")).find(y=>Reflect.get(y,"__formConfig__")===f.matchedData?.formConfig),2500);if(w){r(w);let y=w.closest(".pops-panel-forms-fold[data-fold-enable]");y&&(y.querySelector(".pops-panel-forms-fold-container").click(),await p.sleep(500)),r(w,()=>{o(w);});}else L.error("Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑËèúÂçïÈ°π");return {isFind:true,data:f}}});}),C},G=E=>{const c=new RegExp(E,"i"),C=[],v=(m,f)=>{for(let w=0;w<m.length;w++){const y=m[w];let $=y.forms;if($&&Array.isArray($)){const q=p.deepClone(f);if(y.type==="deepMenu"){const N=p.queryProperty(q,T=>T?.next?{isFind:false,data:T.next}:{isFind:true,data:T});N.next={name:y.text};}v($,q);}else {let q=Reflect.get(y,"text"),N=Reflect.get(y,"description");const T=[q,N];let X=T.findIndex(O=>{if(typeof O=="string")return O.match(c)});if(X!==-1){const O=p.deepClone(f),ee=p.queryProperty(O,A=>A?.next?{isFind:false,data:A.next}:{isFind:true,data:A});ee.next={name:q,matchedData:{path:"",formConfig:y,matchedText:T[X],description:N}};const te=[];p.queryProperty(O,A=>{const j=A?.name;return typeof j=="string"&&j.trim()!==""&&te.push(j),A?.next?{isFind:false,data:A.next}:{isFind:true,data:A}});const de=te.join(le.escapeHtml(" - "));ee.next.matchedData.path=de,C.push(O);}}}};for(let m=0;m<n.length;m++){const f=n[m];if(!f.forms||f.isBottom&&f.id==="script-version")continue;const w=f.forms;if(w&&Array.isArray(w)){let y=f.title;typeof y=="function"&&(y=y()),v(w,{index:m,name:y});}}let M=document.createDocumentFragment();for(const m of C){let f=z(m);M.appendChild(f);}U(),k.append(M);};g.on(I,"input",p.debounce(E=>{g.preventEvent(E);let c=g.val(I).trim();if(c===""){U();return}G(c);},200));},d=null,l=false,s;g.on(t.$shadowRoot,"dblclick","aside.pops-panel-aside .pops-panel-aside-item:not(#script-version)",i),g.on(t.$shadowRoot,"touchend","aside.pops-panel-aside .pops-panel-aside-item:not(#script-version)",(u,h)=>{clearTimeout(s),s=void 0,l&&d===h?(l=false,d=null,i(u)):(s=setTimeout(()=>{l=false;},200),l=true,d=h);},{capture:true}),t.$shadowRoot.appendChild(g.createElement("style",{type:"text/css",textContent:`
					.pops-flashing{
						animation: double-blink 1.5s ease-in-out;
					}
					@keyframes double-blink {
						 0% {
							background-color: initial;
						}
						25% {
							background-color: yellow;
						}
						50% {
							background-color: initial;
						}
						75% {
							background-color: yellow;
						}
						100% {
							background-color: initial;
						}
					}
				`}));},transformKey(e){if(Array.isArray(e)){const t=e.sort();return JSON.stringify(t)}else return e}},Ve={$data:{__storeApiFn:null,get storeApiValue(){return this.__storeApiFn||(this.__storeApiFn=new S.Dictionary),this.__storeApiFn}},getStorageApi(e){if(this.hasStorageApi(e))return this.$data.storeApiValue.get(e)},hasStorageApi(e){return this.$data.storeApiValue.has(e)},setStorageApi(e,t){this.$data.storeApiValue.set(e,t);},initComponentsStorageApi(e,t,n){let a;this.hasStorageApi(e)?a=this.getStorageApi(e):a=n,this.setComponentsStorageApiProperty(t,a);},setComponentsStorageApiProperty(e,t){Reflect.set(e.props,Y,t);}},be=function(e,t,n,a,r,o,i,d){let l={text:e,type:"switch",description:r,disabled:i,attributes:{},props:{},getValue(){return this.props[Y].get(t,n)},callback(s,u){let h=!!u;x.success(`${h?"ÂºÄÂêØ":"ÂÖ≥Èó≠"} ${e}`),this.props[Y].set(t,h);},afterAddToUListCallBack:o};return Reflect.set(l.attributes,J,t),Reflect.set(l.attributes,Q,n),Ve.initComponentsStorageApi("switch",l,{get(s,u){return b.getValue(s,u)},set(s,u){b.setValue(s,u);}}),l},$e={id:"view-general",title:"ÈÄöÁî®",forms:[{type:"forms",text:"ÂäüËÉΩ",forms:[be("ÈªòËÆ§ËßÑÂàô","user-rule-default-enable",true,void 0,"Â¶ÇÊûúÂΩìÂâçÁΩëÁ´ôÊ≤°ÊúâËÆæÁΩÆËßÑÂàôÔºåÈÇ£‰πà‰ΩøÁî®ÈªòËÆ§ËßÑÂàô")]}]},Ae=new ce("user-rule-data"),De=()=>({url:"*://*/*",selector:"img",mode:"handleClickEvent",isPreventDefault:true,clickEvent:`
      const $image = event.target;
      const url = this.ImageUtils.getImageElementUrl($image);
      resolve({
        "isView": true,
        "imageList": [url],
      });
      `}),Re={getImageElementUrl(e){function t(a){return a.trim()==="null"||a.trim()==="undefined"||a.trim()===""}if(e==null||typeof e=="string"&&t(e))return;let n="";if(t(n)&&e.hasAttribute("data-src")&&(n=e.getAttribute("data-src")),t(n)&&e.hasAttribute("src")&&(n=e.getAttribute("src")),t(n)&&e.hasAttribute("alt")&&(n=e.getAttribute("alt")),!t(n))return n}},Le={viewIMG(e,t=0){x.info(["Êü•ÁúãÂõæÁâá",[e,t]]);let n="";e.forEach(o=>{n+=`<li><img data-src="${o}" loading="lazy"></li>`;});let a=g.createElement("ul",{innerHTML:n}),r=new fe(a,{inline:false,url:"data-src",zIndex:p.getMaxZIndex()+100,hidden:()=>{r.destroy();}});t=parseInt(t.toString()),(isNaN(t)||t<0)&&(t=0),r.view(t),r.zoomTo(1),r.show();}},Ie={$data:{get defaultRule(){return De()},get userRule(){return Ae.get("user-rule",[])},currentRule:[]},initUserRule(){x.info("Ê≠£Âú®ÂåπÈÖçÂΩìÂâçÁΩëÁ´ôËßÑÂàô..."),this.$data.userRule.forEach((e,t)=>{if(p.isNull(e)){x.error(["ÊîπËßÑÂàô‰∏çÂ≠òÂú®ÂåπÈÖçUrl",[e,t]]);return}new RegExp(e.url,"gi").test(window.location.href)&&this.$data.currentRule.push(e);}),this.$data.currentRule.length===0&&b.getValue("user-rule-default-enable")&&this.$data.currentRule.push(this.$data.defaultRule),x.success(["ÂΩìÂâçÁöÑÁúãÂõæËßÑÂàô",this.$data.currentRule]),this.$data.currentRule.forEach(e=>{e.mode==="handleClickEvent"?this.handleClickEvent(e):e.mode==="handleElement"?this.handleElement(e):x.error(["Êú™Áü•Ê®°ÂºèÁöÑËßÑÂàô",e]);});},handleClickEvent(e){function t(n){n!=null&&g.on(n,"click",e.selector,async a=>{e.isPreventDefault&&g.preventEvent(a);const r=a.target;if(r instanceof HTMLImageElement&&r.closest(".viewer-container"))return;let o=[],i=0;if(typeof e.clickEvent=="string"){let l=await function(s){return new Promise((u,h)=>{new Function("event","resolve","reject",e.clickEvent).bind({ImageUtils:Re,utils:p,DOMUtils:g})(s,u,h);})}(a);if(!l.isView)return;Array.isArray(l.imageList)&&(o=l.imageList),typeof l.imageIndex=="number"&&(i=l.imageIndex,(i<0||i>=o.length)&&(i=0));}Le.viewIMG(o,i);},{capture:true});}typeof e.context=="string"?g.waitNode(e.context).then(n=>{e.useSelector==="querySelector"?t(xe(e.context)):t(we(e.context));}):t(document);},handleElement(e){}};K.addContentConfig([$e]);b.init();Ie.initUserRule();

})(Qmsg, DOMUtils, Utils, pops, Viewer);