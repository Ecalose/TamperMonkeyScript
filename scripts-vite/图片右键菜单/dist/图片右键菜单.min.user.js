// ==UserScript==
// @name         图片右键菜单
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2025.8.27
// @author       WhiteSevs
// @description  在浏览器预览图片页面添加全局右键菜单，右键直接复制该图片的Uri编码，支持自动判断图片类型，包括：jpg、jpeg、png、gif、webp、ico，支持手动判断图片类型，包括：jpg、jpeg、png、gif。
// @license      GPL-3.0-only
// @icon         data:image/png;base64,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
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://*/*
// @require      https://fastly.jsdelivr.net/gh/WhiteSevs/TamperMonkeyScript@86be74b83fca4fa47521cded28377b35e1d7d2ac/lib/CoverUMD/index.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@2.7.5/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.6.5/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/pops@2.3.6/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.4.0/dist/index.umd.js
// @grant        GM_deleteValue
// @grant        GM_getResourceText
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-start
// ==/UserScript==

(function (x, D, G, z) {
	'use strict';

	var he=typeof GM_deleteValue<"u"?GM_deleteValue:void 0,ae=typeof GM_getResourceText<"u"?GM_getResourceText:void 0,se=typeof GM_getValue<"u"?GM_getValue:void 0,B=typeof GM_info<"u"?GM_info:void 0,me=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,ue=typeof GM_setValue<"u"?GM_setValue:void 0,ye=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,Ce=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,$=typeof unsafeWindow<"u"?unsafeWindow:void 0,xe=window;const ce="GM_Panel",_e="data-init",H="data-key",j="data-default-value",we="data-init-more-value",N="data-storage-api",Y={setting:{get width(){return window.innerWidth<550?"88vw":window.innerWidth<700?"550px":"700px"},get height(){return window.innerHeight<450?"70vh":window.innerHeight<550?"450px":"550px"}},settingMiddle:{get width(){return window.innerWidth<350?"88vw":"350px"}}};class be{storageKey;listenerData;constructor(t){if(typeof t=="string"){let a=t.trim();if(a=="")throw new Error("key参数不能为空字符串");this.storageKey=a;}else throw new Error("key参数类型错误，必须是字符串");this.listenerData=new G.Dictionary;}getLocalValue(){let t=se(this.storageKey);return t==null&&(t={},this.setLocalValue(t)),t}setLocalValue(t){ue(this.storageKey,t);}set(t,a){let n=this.get(t),i=this.getLocalValue();Reflect.set(i,t,a),this.setLocalValue(i),this.triggerValueChangeListener(t,n,a);}get(t,a){let n=this.getLocalValue();return Reflect.get(n,t)??a}getAll(){return this.getLocalValue()}delete(t){let a=this.get(t),n=this.getLocalValue();Reflect.deleteProperty(n,t),this.setLocalValue(n),this.triggerValueChangeListener(t,a,void 0);}has(t){let a=this.getLocalValue();return Reflect.has(a,t)}keys(){let t=this.getLocalValue();return Reflect.ownKeys(t)}values(){let t=this.getLocalValue();return Reflect.ownKeys(t).map(a=>Reflect.get(t,a))}clear(){he(this.storageKey);}addValueChangeListener(t,a){let n=Math.random(),i=this.listenerData.get(t)||[];return i.push({id:n,key:t,callback:a}),this.listenerData.set(t,i),n}removeValueChangeListener(t){let a=false;for(const[n,i]of this.listenerData.entries()){for(let r=0;r<i.length;r++){const l=i[r];(typeof t=="string"&&l.key===t||typeof t=="number"&&l.id===t)&&(i.splice(r,1),r--,a=true);}this.listenerData.set(n,i);}return a}triggerValueChangeListener(t,a,n){if(!this.listenerData.has(t))return;let i=this.listenerData.get(t);for(let r=0;r<i.length;r++){const l=i[r];if(typeof l.callback=="function"){let c=this.get(t),o,f;typeof a<"u"&&arguments.length>=2?f=a:f=c,typeof n<"u"&&arguments.length>2?o=n:o=c,l.callback(t,f,o);}}}}const k=new be(ce),Z={$data:{__contentConfig:null,get contentConfig(){return this.__contentConfig==null&&(this.__contentConfig=new s.Dictionary),this.__contentConfig}},addContentConfig(e){Array.isArray(e)||(e=[e]);let t=this.$data.contentConfig.keys().length;this.$data.contentConfig.set(t,e);},getAllContentConfig(){return this.$data.contentConfig.values().flat()},getConfig(e=0){return this.$data.contentConfig.get(e)??[]},getDefaultBottomContentConfig(){return [{id:"script-version",title:`版本：${B?.script?.version||"未知"}`,isBottom:true,forms:[],clickFirstCallback(e,t,a){let n=B?.script?.supportURL||B?.script?.namespace;return typeof n=="string"&&s.isNotNull(n)&&window.open(n,"_blank"),false}}]}},ve={$data:{__menuOption:[{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:false,isStoreValue:false,showText(e){return e},callback:()=>{M.showPanel(Z.getConfig(0));}}],get menuOption(){return this.__menuOption}},init(){this.initExtensionsMenu();},initExtensionsMenu(){M.isTopWindow()&&Ve.add(this.$data.menuOption);},addMenuOption(e){Array.isArray(e)||(e=[e]),this.$data.menuOption.push(...e);},updateMenuOption(e){Array.isArray(e)||(e=[e]),e.forEach(t=>{let a=this.$data.menuOption.findIndex(n=>n.key===t.key);a!==-1&&(this.$data.menuOption[a]=t);});},getMenuOption(e=0){return this.$data.menuOption[e]},deleteMenuOption(e=0){this.$data.menuOption.splice(e,1);}},de={waitRemove(...e){e.forEach(t=>{typeof t=="string"&&s.waitNodeList(t).then(a=>{a.forEach(n=>n.remove());});});},addBlockCSS(...e){let t=[];if(e.length!==0&&!(e.length===1&&typeof e[0]=="string"&&e[0].trim()===""))return e.forEach(a=>{Array.isArray(a)?t=t.concat(a):t.push(a);}),re(`${t.join(`,
`)}{display: none !important;}`)},setGMResourceCSS(e){let t=typeof ae=="function"?ae(e.keyName):null;typeof t=="string"&&t?re(t):de.loadStyleLink(e.url);},async loadStyleLink(e){let t=document.createElement("link");t.rel="stylesheet",t.type="text/css",t.href=e,D.ready(()=>{document.head.appendChild(t);});},async loadScript(e){let t=document.createElement("script");return t.src=e,new Promise(a=>{t.onload=()=>{a(null);},(document.head||document.documentElement).appendChild(t);})},fixUrl(e){return e=e.trim(),e.match(/^http(s|):\/\//i)?e:e.startsWith("//")?(e.startsWith("///")||(e=window.location.protocol+e),e):(e.startsWith("/")||(e+="/"),e=window.location.origin+e,e)},fixHttps(e){if(e.startsWith("https://")||!e.startsWith("http://"))return e;let t=new URL(e);return t.protocol="https:",t.toString()},lockScroll(...e){let t=document.createElement("style");t.innerHTML=`
			.pops-overflow-hidden-important {
				overflow: hidden !important;
			}
		`;let a=[document.documentElement,document.body].concat(...e||[]);return a.forEach(n=>{n.classList.add("pops-overflow-hidden-important");}),(document.head||document.documentElement).appendChild(t),{recovery(){a.forEach(n=>{n.classList.remove("pops-overflow-hidden-important");}),t.remove();}}},async getClipboardText(){function e(n){navigator.clipboard.readText().then(i=>{n(i);}).catch(i=>{_.error("读取剪贴板内容失败👉",i),n("");});}function t(n){navigator.permissions.query({name:"clipboard-read"}).then(i=>{e(n);}).catch(i=>{_.error("申请剪贴板权限失败，尝试直接读取👉",i.message??i.name??i.stack),e(n);});}function a(){return !(typeof navigator?.clipboard?.readText!="function"||typeof navigator?.permissions?.query!="function")}return new Promise(n=>{if(!a()){n("");return}document.hasFocus()?t(n):window.addEventListener("focus",()=>{t(n);},{once:true});})},escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/©/g,"&copy;").replace(/®/g,"&reg;").replace(/™/g,"&trade;").replace(/→/g,"&rarr;").replace(/←/g,"&larr;").replace(/↑/g,"&uarr;").replace(/↓/g,"&darr;").replace(/—/g,"&mdash;").replace(/–/g,"&ndash;").replace(/…/g,"&hellip;").replace(/ /g,"&nbsp;").replace(/\r\n/g,"<br>").replace(/\r/g,"<br>").replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;")},interval(e,t,a=5e3){let n,i=a-t,r=t,l=async c=>{let o=await e(c);if(typeof o=="boolean"&&!o||c){s.workerClearTimeout(n);return}if(r+=t,r>i){l(true);return}n=s.workerSetTimeout(()=>{l(false);},t);};l(false);},findParentNode(e,t,a){if(a){let n=D.closest(e,a);if(n)return n.querySelector(t)}else return D.matches(e,t)?e:D.closest(e,t)}},M={$data:{__contentConfigInitDefaultValue:null,__onceExecMenuData:null,__onceExecData:null,__panelConfig:{},$panel:null,panelContent:[],get contentConfigInitDefaultValue(){return this.__contentConfigInitDefaultValue==null&&(this.__contentConfigInitDefaultValue=new s.Dictionary),this.__contentConfigInitDefaultValue},contentConfigInitDisabledKeys:[],get onceExecMenuData(){return this.__onceExecMenuData==null&&(this.__onceExecMenuData=new s.Dictionary),this.__onceExecMenuData},get onceExecData(){return this.__onceExecData==null&&(this.__onceExecData=new s.Dictionary),this.__onceExecData},get scriptName(){return ie},get panelConfig(){return this.__panelConfig},set panelConfig(e){this.__panelConfig=e;},key:ce,attributeKeyName:H,attributeDefaultValueName:j},init(){this.initContentDefaultValue(),ve.init();},isTopWindow(){return $.top===$.self},initContentDefaultValue(){const e=n=>{if(!n.attributes||n.type==="button"||n.type==="forms"||n.type==="deepMenu")return;let i=new Map,r=n.attributes[H];if(r!=null){const o=n.attributes[j];i.set(r,o);}let l=n.attributes[we];if(typeof l=="object"&&l&&Object.keys(l).forEach(o=>{i.set(o,l[o]);}),!i.size){_.warn(["请先配置键",n]);return}let c=n.attributes[_e];if(typeof c=="function"){let o=c();if(typeof o=="boolean"&&!o)return}if(n.type==="switch"){let o=typeof n.disabled=="function"?n.disabled():n.disabled;typeof o=="boolean"&&o&&this.$data.contentConfigInitDisabledKeys.push(...i.keys());}for(const[o,f]of i.entries())this.setDefaultValue(o,f);},t=n=>{for(let i=0;i<n.length;i++){let r=n[i];e(r);let l=r.forms;l&&Array.isArray(l)&&t(l);}},a=[...Z.getAllContentConfig()];for(let n=0;n<a.length;n++){let i=a[n];if(!i.forms)continue;const r=i.forms;r&&Array.isArray(r)&&t(r);}this.$data.contentConfigInitDisabledKeys=[...new Set(this.$data.contentConfigInitDisabledKeys)];},setDefaultValue(e,t){this.$data.contentConfigInitDefaultValue.has(e)&&_.warn("请检查该key(已存在): "+e),this.$data.contentConfigInitDefaultValue.set(e,t);},setValue(e,t){k.set(e,t);},getValue(e,t){let a=k.get(e);return a??(this.$data.contentConfigInitDefaultValue.has(e)?this.$data.contentConfigInitDefaultValue.get(e):t)},deleteValue(e){k.delete(e);},hasKey(e){return k.has(e)},addValueChangeListener(e,t){return k.addValueChangeListener(e,(n,i,r)=>{t(e,r,i);})},removeValueChangeListener(e){k.removeValueChangeListener(e);},triggerMenuValueChange(e,t,a){k.triggerValueChangeListener(e,a,t);},exec(e,t,a,n=true){const i=this;let r;typeof e=="string"||Array.isArray(e)?r=()=>e:r=e;let l=false,c=r(),o=[];Array.isArray(c)?(l=true,o=c):o.push(c);let f=o.find(d=>!this.$data.contentConfigInitDefaultValue.has(d));if(f){_.warn(`${f} 键不存在`);return}let u=JSON.stringify(o);if(n){if(this.$data.onceExecMenuData.has(u))return;this.$data.onceExecMenuData.set(u,1);}let g=[],h=[],S=(d,y)=>{let b=[];Array.isArray(y)||(y=[y]),y.forEach(v=>{if(v!=null&&v instanceof HTMLStyleElement){b.push(v);return}}),g=g.concat(b);},R=d=>this.getValue(d),U=()=>{for(let d=0;d<g.length;d++)g[d].remove(),g.splice(d,1),d--;},Q=()=>{let d=false;return typeof a=="function"?d=a(o):d=o.every(y=>R(y)),d},W=d=>{let y=Q(),b=[];if(y){let v=o.map(p=>this.getValue(p)),m=t({value:l?v:v[0],addStyleElement:(...p)=>S(true,...p)});Array.isArray(m)||(m=[m]),m.forEach(p=>{if(p!=null&&p instanceof HTMLStyleElement){b.push(p);return}});}U(),g=[...b];};return n&&o.forEach(d=>{let y=this.addValueChangeListener(d,(b,v,m)=>{W();});h.push(y);}),W(),{clear(){this.clearStoreStyleElements(),this.removeValueChangeListener(),n&&i.$data.onceExecMenuData.delete(u);},clearStoreStyleElements:()=>U(),removeValueChangeListener:()=>{h.forEach(d=>{this.removeValueChangeListener(d);});}}},execMenu(e,t,a=false,n=false){return this.exec(e,i=>t(i),i=>i.every(l=>{let c=!!this.getValue(l);return M.$data.contentConfigInitDisabledKeys.includes(l)&&(c=false,_.warn(`.execMenu${n?"Once":""} ${l} 被禁用`)),a&&(c=!c),c}),n)},execMenuOnce(e,t,a=false){return this.execMenu(e,t,a,true)},deleteExecMenuOnce(e){return this.$data.onceExecMenuData.delete(e),k.removeValueChangeListener(e)},onceExec(e,t){if(e=this.transformKey(e),typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExecData.has(e)||(t(),this.$data.onceExecData.set(e,1));},deleteOnceExec(e){e=this.transformKey(e),this.$data.onceExecData.delete(e);},showPanel(e,t=`${ie}-设置`,a=false,n=false){this.$data.$panel=null,this.$data.panelContent=[];let i=e.findIndex(l=>(typeof l.isBottom=="function"?l.isBottom():!!l.isBottom)&&l.id==="script-version")!==-1;!a&&!i&&e.push(...Z.getDefaultBottomContentConfig());let r=V.panel({title:{text:t,position:"center",html:false,style:""},content:e,btn:{close:{enable:true,callback:(l,c)=>{l.close(),this.$data.$panel=null;}}},mask:{enable:true,clickEvent:{toClose:true,toHide:false},clickCallBack:(l,c)=>{l(),this.$data.$panel=null;}},width:Y.setting.width,height:Y.setting.height,drag:true,only:true,...this.$data.panelConfig});this.$data.$panel=r,this.$data.panelContent=e,n||this.registerConfigSearch({$panel:r,content:e});},registerConfigSearch(e){const{$panel:t,content:a}=e;let n=async(u,g)=>{if(u==null)return;let h=await g(u);return h&&typeof h.isFind=="boolean"&&h.isFind?h.data:await n(h.data,g)},i=(u,g)=>{const h=new IntersectionObserver(S=>{S.forEach(R=>{R.isIntersecting&&(g?.(),h.disconnect());});},{root:null,threshold:1});h.observe(u),u.scrollIntoView({behavior:"smooth",block:"center"});},r=u=>{const g="pops-flashing";E.animationend(u,()=>{u.classList.remove(g);}),u.classList.add(g);},l=(u,g)=>{s.preventEvent(u);let h=V.alert({title:{text:"搜索配置",position:"center"},content:{text:`
						<div class="search-wrapper">
							<input class="search-config-text" name="search-config" type="text" placeholder="请输入需要搜素的配置名称">
						</div>
						<div class="search-result-wrapper"></div>
					`,html:true},btn:{ok:{enable:false}},mask:{clickEvent:{toClose:true}},width:Y.settingMiddle.width,height:"auto",drag:true,style:`
					${V.config.cssText.panelCSS}

					.search-wrapper{
						border-bottom: 1px solid rgb(235, 238, 245, 1);
					}
					.pops-content:has(.search-result-wrapper:empty) .search-wrapper{
						border-bottom: 0;
					}
					.search-config-text{
						width: 100%;
						border: 0;
						height: 32px;
						padding: 0px 10px;
						outline: none;
					}
					.search-result-wrapper{
						max-height: 400px;
						overflow: auto;
					}
					.search-result-item{
						cursor: pointer;
						padding: 5px 10px;
						display: flex;
						flex-direction: column;
					}
					.search-result-item:hover{
						background-color: #D8F1FD;
					}
					.search-result-item-path{
						display: flex;
    					align-items: center;
					}
					.search-result-item-description{
						font-size: 0.8rem;
						color: #6c6c6c;
					}
					${e.searchDialogStyle??""}
				`});h.$shadowRoot.querySelector(".search-wrapper");let S=h.$shadowRoot.querySelector(".search-config-text"),R=h.$shadowRoot.querySelector(".search-result-wrapper");S.focus();let U=()=>{E.empty(R);},Q=A=>{const d=s.queryProperty(A,b=>b?.next?{isFind:false,data:b.next}:{isFind:true,data:b});let y=E.createElement("div",{className:"search-result-item",innerHTML:`
							<div class="search-result-item-path">${d.matchedData?.path}</div>
							<div class="search-result-item-description">${d.matchedData?.description??""}</div>
						`});return E.on(y,"click",b=>{let m=t.$shadowRoot.querySelectorAll("aside.pops-panel-aside .pops-panel-aside-top-container li")[A.index];if(!m){x.error(`左侧项下标${A.index}不存在`);return}m.scrollIntoView({behavior:"smooth",block:"center"}),m.click(),n(A.next,async p=>{if(p?.next){let w=await s.waitNode(()=>Array.from(t.$shadowRoot.querySelectorAll(".pops-panel-deepMenu-nav-item")).find(C=>{const I=Reflect.get(C,"__formConfig__");return typeof I=="object"&&I!=null&&I.text===p.name}),2500);if(w)w.click();else return x.error("未找到对应的二级菜单"),{isFind:true,data:p};return {isFind:false,data:p.next}}else {let w=await s.waitNode(()=>Array.from(t.$shadowRoot.querySelectorAll("li:not(.pops-panel-deepMenu-nav-item)")).find(C=>Reflect.get(C,"__formConfig__")===p.matchedData?.formConfig),2500);if(w){i(w);let C=w.closest(".pops-panel-forms-fold[data-fold-enable]");C&&(C.querySelector(".pops-panel-forms-fold-container").click(),await s.sleep(500)),i(w,()=>{r(w);});}else x.error("未找到对应的菜单项");return {isFind:true,data:p}}});}),y},W=A=>{const d=new RegExp(A,"i"),y=[],b=(m,p)=>{for(let w=0;w<m.length;w++){const C=m[w];let I=C.forms;if(I&&Array.isArray(I)){const O=s.deepClone(p);if(C.type==="deepMenu"){const K=s.queryProperty(O,F=>F?.next?{isFind:false,data:F.next}:{isFind:true,data:F});K.next={name:C.text};}b(I,O);}else {let O=Reflect.get(C,"text"),K=Reflect.get(C,"description");const F=[O,K];let ee=F.findIndex(q=>{if(typeof q=="string")return q.match(d)});if(ee!==-1){const q=s.deepClone(p),te=s.queryProperty(q,L=>L?.next?{isFind:false,data:L.next}:{isFind:true,data:L});te.next={name:O,matchedData:{path:"",formConfig:C,matchedText:F[ee],description:K}};const ne=[];s.queryProperty(q,L=>{const J=L?.name;return typeof J=="string"&&J.trim()!==""&&ne.push(J),L?.next?{isFind:false,data:L.next}:{isFind:true,data:L}});const ge=ne.join(de.escapeHtml(" - "));te.next.matchedData.path=ge,y.push(q);}}}};for(let m=0;m<a.length;m++){const p=a[m];if(!p.forms||p.isBottom&&p.id==="script-version")continue;const w=p.forms;if(w&&Array.isArray(w)){let C=p.title;typeof C=="function"&&(C=C()),b(w,{index:m,name:C});}}let v=document.createDocumentFragment();for(const m of y){let p=Q(m);v.appendChild(p);}U(),R.append(v);};E.on(S,"input",s.debounce(A=>{s.preventEvent(A);let d=E.val(S).trim();if(d===""){U();return}W(d);},200));},c=null,o=false,f;E.on(t.$shadowRoot,"dblclick","aside.pops-panel-aside .pops-panel-aside-item:not(#script-version)",l),E.on(t.$shadowRoot,"touchend","aside.pops-panel-aside .pops-panel-aside-item:not(#script-version)",(u,g)=>{clearTimeout(f),f=void 0,o&&c===g?(o=false,c=null,l(u)):(f=setTimeout(()=>{o=false;},200),o=true,c=g);},{capture:true}),t.$shadowRoot.appendChild(E.createElement("style",{type:"text/css",textContent:`
					.pops-flashing{
						animation: double-blink 1.5s ease-in-out;
					}
					@keyframes double-blink {
						 0% {
							background-color: initial;
						}
						25% {
							background-color: yellow;
						}
						50% {
							background-color: initial;
						}
						75% {
							background-color: yellow;
						}
						100% {
							background-color: initial;
						}
					}
				`}));},transformKey(e){if(Array.isArray(e)){const t=e.sort();return JSON.stringify(t)}else return e}},P={qmsg_config_position:{key:"qmsg-config-position",defaultValue:"bottom"},qmsg_config_maxnums:{key:"qmsg-config-maxnums",defaultValue:3},qmsg_config_showreverse:{key:"qmsg-config-showreverse",defaultValue:false}},s=G.noConflict(),E=D.noConflict(),V=z,_=new s.Log(B,$.console||xe.console);let ie=B?.script?.name||void 0;z.config.Utils.AnyTouch();const fe=false;_.config({debug:fe,logMaxCount:1e3,autoClearConsole:true,tag:true});x.config({isHTML:true,autoClose:true,showClose:false,consoleLogContent(e){const t=e.getSetting().type;if(t==="loading")return  false;const a=e.getSetting().content;return t==="warning"?_.warn(a):t==="error"?_.error(a):_.info(a),true},get position(){return M.getValue(P.qmsg_config_position.key,P.qmsg_config_position.defaultValue)},get maxNums(){return M.getValue(P.qmsg_config_maxnums.key,P.qmsg_config_maxnums.defaultValue)},get showReverse(){return M.getValue(P.qmsg_config_showreverse.key,P.qmsg_config_showreverse.defaultValue)},get zIndex(){let e=G.getMaxZIndex(),t=z.config.InstanceUtils.getPopsMaxZIndex().zIndex;return G.getMaxValue(e,t)+100}});V.GlobalConfig.setGlobalConfig({zIndex:()=>{let e=G.getMaxZIndex(void 0,void 0,a=>{if(a?.classList?.contains("qmsg-shadow-container")||a?.closest("qmsg")&&a.getRootNode()instanceof ShadowRoot)return  false}),t=z.config.InstanceUtils.getPopsMaxZIndex().zIndex;return G.getMaxValue(e,t)+100},mask:{enable:true,clickEvent:{toClose:false,toHide:false}},drag:true});const Ve=new s.GM_Menu({GM_getValue:se,GM_setValue:ue,GM_registerMenuCommand:me,GM_unregisterMenuCommand:ye}),X=new s.Httpx({xmlHttpRequest:Ce,logDetails:fe});X.interceptors.request.use(e=>e);X.interceptors.response.use(void 0,e=>(_.error("拦截器-请求错误",e),e.type==="onabort"?x.warning("请求取消",{consoleLogContent:true}):e.type==="onerror"?x.error("请求异常",{consoleLogContent:true}):e.type==="ontimeout"?x.error("请求超时",{consoleLogContent:true}):x.error("其它错误",{consoleLogContent:true}),e));$.Object.defineProperty,$.Function.prototype.apply,$.Function.prototype.call,$.Element.prototype.appendChild,$.setTimeout;const re=s.addStyle.bind(s);D.selector.bind(D);D.selectorAll.bind(D);new s.GM_Cookie;const T={default:{getBase64Image(e,t="image/png"){var a=document.createElement("canvas");a.width=e.width,a.height=e.height;var n=a.getContext("2d");n.drawImage(e,0,0,e.width,e.height);var i=a.toDataURL("image/png");return i}},gif:{getImageFileFromUrl(e,t,a){fetch(e).then(n=>n.blob()).then(n=>{let i=new File([n],t,{type:"image/gif"});a(i);});},chooseStaticImg(e){let t=null;return new Promise((a,n)=>{this.getImageFileFromUrl(e,"图片.gif",i=>{let r=new FileReader;r.onloadend=()=>{t=r.result,a(t);},r.readAsDataURL(i);});})}},async networkQueryContentType(e){let t=await X.head(e,{fetch:true});if(t.status&&t.data.responseFetchHeaders.has("Content-Type"))return t.data.responseFetchHeaders.get("Content-Type")}},oe=[{rule:".png",type:"image/png"},{rule:".jpg",type:"image/jpg"},{rule:".jpeg",type:"image/jpeg"},{rule:".webp",type:"image/webp"},{rule:".ico",type:"image/ico"},{rule:".gif",type:"image/gif"}],Me={init(){let e=document.body.querySelectorAll("img");if(e.length!==1){_.error("页面中的<img>元素数量不为1");return}_.info("注入全局右键-图片");let t=e[0],a=t.src;V.rightClickMenu({target:$,data:[{icon:V.config.iconSVG.documentCopy,iconIsLoading:false,text:"自动判断",async callback(){let n=null;if(a.startsWith("http")||a.startsWith("file:")){let i=-1;i=oe.findIndex(r=>a.endsWith(r.rule)),i!==-1&&(n=oe[i].type),!n&&a.startsWith("http")&&(x.info("通过网络请求判断类型"),n=await T.networkQueryContentType(a),_.info("请求获取的Content-Type："+n),n&&x.success("图片类型："+n));}n?n.endsWith("gif")?T.gif.chooseStaticImg(a).then(i=>{s.setClip(i),x.success("复制成功！");}):(s.setClip(T.default.getBase64Image(t,n)),x.success("复制成功！")):x.error("未知的图片类型");}},{icon:V.config.iconSVG.chromeFilled,iconIsLoading:false,text:"其它类型",callback(n){return  false},item:[{icon:V.config.iconSVG.documentCopy,iconIsLoading:false,text:"jpg",callback(){s.setClip(T.default.getBase64Image(t,"image/jpg")),x.success("复制成功！");}},{icon:V.config.iconSVG.documentCopy,iconIsLoading:false,text:"jpeg",callback(){s.setClip(T.default.getBase64Image(t,"image/jpeg")),x.success("复制成功！");}},{icon:V.config.iconSVG.documentCopy,iconIsLoading:false,text:"png",callback(){s.setClip(T.default.getBase64Image(t,"image/png")),x.success("复制成功！");}},{icon:V.config.iconSVG.documentCopy,iconIsLoading:false,text:"gif",callback(){T.gif.chooseStaticImg(a).then(n=>{s.setClip(n),x.success("复制成功！");});}}]}]});}},pe={$data:{__storeApiFn:null,get storeApiValue(){return this.__storeApiFn||(this.__storeApiFn=new G.Dictionary),this.__storeApiFn}},getStorageApi(e){if(this.hasStorageApi(e))return this.$data.storeApiValue.get(e)},hasStorageApi(e){return this.$data.storeApiValue.has(e)},setStorageApi(e,t){this.$data.storeApiValue.set(e,t);},initComponentsStorageApi(e,t,a){let n;this.hasStorageApi(e)?n=this.getStorageApi(e):n=a,this.setComponentsStorageApiProperty(t,n);},setComponentsStorageApiProperty(e,t){Reflect.set(e.props,N,t);}},Ae=function(e,t,a,n,i,r,l,c){let o={text:e,type:"switch",description:i,disabled:l,attributes:{},props:{},getValue(){return this.props[N].get(t,a)},callback(f,u){let g=!!u;_.success(`${g?"开启":"关闭"} ${e}`),this.props[N].set(t,g);},afterAddToUListCallBack:r};return Reflect.set(o.attributes,H,t),Reflect.set(o.attributes,j,a),pe.initComponentsStorageApi("switch",o,{get(f,u){return M.getValue(f,u)},set(f,u){M.setValue(f,u);}}),o},le=function(e,t,a,n,i,r,l){let c=[];typeof n=="function"?c=n():c=n;let o={text:e,type:"select",description:r,attributes:{},props:{},getValue(){return this.props[N].get(t,a)},callback(f,u,g){let h=u;if(_.info(`选择：${g}`),typeof i=="function"&&i(f,h,g))return;this.props[N].set(t,h);},data:c};return Reflect.set(o.attributes,H,t),Reflect.set(o.attributes,j,a),pe.initComponentsStorageApi("select",o,{get(f,u){return M.getValue(f,u)},set(f,u){M.setValue(f,u);}}),o},Ie={id:"component-common",title:"通用",forms:[{text:"Toast配置",type:"forms",forms:[le("Toast位置","qmsg-config-position","bottom",[{value:"topleft",text:"左上角"},{value:"top",text:"顶部"},{value:"topright",text:"右上角"},{value:"left",text:"左边"},{value:"center",text:"中间"},{value:"right",text:"右边"},{value:"bottomleft",text:"左下角"},{value:"bottom",text:"底部"},{value:"bottomright",text:"右下角"}],(e,t,a)=>{_.info("设置当前Qmsg弹出位置"+a);},"Toast显示在页面九宫格的位置"),le("最多显示的数量","qmsg-config-maxnums",3,[{value:1,text:"1"},{value:2,text:"2"},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],void 0,"限制Toast显示的数量"),Ae("逆序弹出","qmsg-config-showreverse",false,void 0,"修改Toast弹出的顺序")]}]};Z.addContentConfig([Ie]),document.documentElement.hasAttribute("style")&&document.body.hasAttribute("style")&&document.body.children.length&&document.querySelector('meta[name="viewport"]')&&(M.init(),Me.init());

})(Qmsg, DOMUtils, Utils, pops);