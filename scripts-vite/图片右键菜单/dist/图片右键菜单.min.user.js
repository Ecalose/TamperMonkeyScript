// ==UserScript==
// @name         图片右键菜单
// @namespace    https://github.com/WhiteSevs/TamperMonkeyScript
// @version      2024.7.24
// @author       WhiteSevs
// @description  在浏览器预览图片页面添加全局右键菜单，右键直接复制该图片的Uri编码，支持自动判断图片类型，包括：jpg、jpeg、png、gif、webp、ico，支持手动判断图片类型，包括：jpg、jpeg、png、gif。
// @license      GPL-3.0-only
// @icon         data:image/png;base64,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
// @supportURL   https://github.com/WhiteSevs/TamperMonkeyScript/issues
// @match        *://*/*
// @require      https://update.greasyfork.org/scripts/494167/1413255/CoverUMD.js
// @require      https://fastly.jsdelivr.net/npm/qmsg@1.2.1/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/utils@2.1.0/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/domutils@1.3.0/dist/index.umd.js
// @require      https://fastly.jsdelivr.net/npm/@whitesev/pops@1.5.0/dist/index.umd.js
// @grant        GM_getValue
// @grant        GM_info
// @grant        GM_registerMenuCommand
// @grant        GM_setValue
// @grant        GM_unregisterMenuCommand
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @run-at       document-end
// ==/UserScript==

(function (r, L, V, S) {
	'use strict';

	var w=typeof GM_getValue<"u"?GM_getValue:void 0,C=typeof GM_info<"u"?GM_info:void 0,P=typeof GM_registerMenuCommand<"u"?GM_registerMenuCommand:void 0,I=typeof GM_setValue<"u"?GM_setValue:void 0,U=typeof GM_unregisterMenuCommand<"u"?GM_unregisterMenuCommand:void 0,A=typeof GM_xmlhttpRequest<"u"?GM_xmlhttpRequest:void 0,p=typeof unsafeWindow<"u"?unsafeWindow:void 0,F=window;const B="图片右键菜单",c=V.noConflict();L.noConflict();const m=S,f=new c.Log(C,p.console||F.console);var T;const E=((T=C==null?void 0:C.script)==null?void 0:T.name)||B,$=!1;f.config({debug:$,logMaxCount:1e3,autoClearConsole:!0,tag:!0});r.config(Object.defineProperties({html:!0,autoClose:!0,showClose:!1},{position:{get(){return d.getValue("qmsg-config-position","bottom")}},maxNums:{get(){return d.getValue("qmsg-config-maxnums",5)}},showReverse:{get(){return d.getValue("qmsg-config-showreverse",!0)}},zIndex:{get(){let e=V.getMaxZIndex(),t=S.config.InstanceUtils.getPopsMaxZIndex(e).zIndex;return V.getMaxValue(e,t)+100}}}));const R=new c.GM_Menu({GM_getValue:w,GM_setValue:I,GM_registerMenuCommand:P,GM_unregisterMenuCommand:U}),b=new c.Httpx(A);b.interceptors.request.use(e=>e);b.interceptors.response.use(void 0,e=>(f.error(["拦截器-请求错误",e]),e.type==="onabort"?r.warning("请求取消"):e.type==="onerror"?r.error("请求异常"):e.type==="ontimeout"?r.error("请求超时"):r.error("其它错误"),e));b.config({logDetails:$});p.Object.defineProperty,p.Function.prototype.apply,p.Function.prototype.call,p.Element.prototype.appendChild,p.setTimeout;const x="GM_Panel",v="data-key",_="data-default-value",W=function(e,t,n,i,a){let o={text:e,type:"switch",description:a,attributes:{},getValue(){return !!d.getValue(t,n)},callback(l,s){f.success(`${s?"开启":"关闭"} ${e}`),d.setValue(t,!!s);},afterAddToUListCallBack:void 0};return o.attributes&&(o.attributes[v]=t,o.attributes[_]=!!n),o},D=function(e,t,n,i,a,o){let l=[];typeof i=="function"?l=i():l=i;let s={text:e,type:"select",description:o,attributes:{},getValue(){return d.getValue(t,n)},callback(h,u,M){d.setValue(t,u),typeof a=="function"&&a(h,u,M);},data:l};return s.attributes&&(s.attributes[v]=t,s.attributes[_]=n),s},j={id:"component-common",title:"通用",forms:[{text:"Toast配置",type:"forms",forms:[D("Toast位置","qmsg-config-position","bottom",[{value:"topleft",text:"左上角"},{value:"top",text:"顶部"},{value:"topright",text:"右上角"},{value:"left",text:"左边"},{value:"center",text:"中间"},{value:"right",text:"右边"},{value:"bottomleft",text:"左下角"},{value:"bottom",text:"底部"},{value:"bottomright",text:"右下角"}],(e,t,n)=>{f.info("设置当前Qmsg弹出位置"+n);},"Toast显示在页面九宫格的位置"),D("最多显示的数量","qmsg-config-maxnums",3,[{value:1,text:"1"},{value:2,text:"2"},{value:3,text:"3"},{value:4,text:"4"},{value:5,text:"5"}],void 0,"限制Toast显示的数量"),W("逆序弹出","qmsg-config-showreverse",!1,void 0,"修改Toast弹出的顺序")]}]},g={data:null,oneSuccessExecMenu:null,onceExec:null,listenData:null},d={$data:{get data(){return g.data==null&&(g.data=new c.Dictionary),g.data},get oneSuccessExecMenu(){return g.oneSuccessExecMenu==null&&(g.oneSuccessExecMenu=new c.Dictionary),g.oneSuccessExecMenu},get onceExec(){return g.onceExec==null&&(g.onceExec=new c.Dictionary),g.onceExec},get scriptName(){return E},key:x,attributeKeyName:v,attributeDefaultValueName:_},$listener:{get listenData(){return g.listenData==null&&(g.listenData=new c.Dictionary),g.listenData}},init(){this.initPanelDefaultValue(),this.initExtensionsMenu();},initExtensionsMenu(){p.top===p.self&&R.add([{key:"show_pops_panel_setting",text:"⚙ 设置",autoReload:!1,isStoreValue:!1,showText(e){return e},callback:()=>{this.showPanel();}}]);},initPanelDefaultValue(){let e=this;function t(a){if(!a.attributes)return;let o=a.attributes[v],l=a.attributes[_];if(o==null){f.warn(["请先配置键",a]);return}e.$data.data.has(o)&&f.warn("请检查该key(已存在): "+o),e.$data.data.set(o,l);}function n(a){for(let o=0;o<a.length;o++){let l=a[o];t(l);let s=l.forms;s&&Array.isArray(s)&&n(s);}}let i=this.getPanelContentConfig();for(let a=0;a<i.length;a++){let o=i[a];if(!o.forms)continue;let l=o.forms;l&&Array.isArray(l)&&n(l);}},setValue(e,t){let n=w(x,{}),i=n[e];n[e]=t,I(x,n),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,i,t);},getValue(e,t){let i=w(x,{})[e];return i??(this.$data.data.has(e)?this.$data.data.get(e):t)},deleteValue(e){let t=w(x,{}),n=t[e];Reflect.deleteProperty(t,e),I(x,t),this.$listener.listenData.has(e)&&this.$listener.listenData.get(e).callback(e,n,void 0);},addValueChangeListener(e,t){let n=Math.random();return this.$listener.listenData.set(e,{id:n,key:e,callback:t}),n},removeValueChangeListener(e){let t=null;for(const[n,i]of this.$listener.listenData.entries())if(i.id===e){t=n;break}typeof t=="string"?this.$listener.listenData.delete(t):console.warn("没有找到对应的监听器");},hasKey(e){let t=w(x,{});return e in t},execMenu(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){f.warn(`${e} 键不存在`);return}let n=d.getValue(e);n&&t(n);},execMenuOnce(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");if(!this.$data.data.has(e)){f.warn(`${e} 键不存在`);return}if(this.$data.oneSuccessExecMenu.has(e))return;this.$data.oneSuccessExecMenu.set(e,1);let n=[],i=l=>{let s=d.getValue(e);a(s,l);},a=(l,s)=>{let h=[];if(l){let u=s??t(l,i);u instanceof HTMLStyleElement?h=[u]:Array.isArray(u)&&(h=[...u.filter(M=>M!=null&&M instanceof HTMLStyleElement)]);}for(let u=0;u<n.length;u++)n[u].remove(),n.splice(u,1),u--;n=[...h];};this.addValueChangeListener(e,(l,s,h)=>{a(h);});let o=d.getValue(e);o&&a(o);},onceExec(e,t){if(typeof e!="string")throw new TypeError("key 必须是字符串");this.$data.onceExec.has(e)||(t(),this.$data.onceExec.set(e,1));},showPanel(){m.panel({title:{text:`${E}-设置`,position:"center",html:!1,style:""},content:this.getPanelContentConfig(),mask:{enable:!0,clickEvent:{toClose:!0,toHide:!1}},isMobile:this.isMobile(),width:this.getWidth(),height:this.getHeight(),drag:!0,only:!0});},isMobile(){return window.outerWidth<550},getWidth(){return window.outerWidth<550?"92vw":"550px"},getHeight(){return window.outerHeight>450?"80vh":"450px"},getPanelContentConfig(){return [j]}},y={default:{getBase64Image(e,t="image/png"){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var i=n.getContext("2d");i.drawImage(e,0,0,e.width,e.height);var a=n.toDataURL("image/png");return a}},gif:{getImageFileFromUrl(e,t,n){fetch(e).then(i=>i.blob()).then(i=>{let a=new File([i],t,{type:"image/gif"});n(a);});},chooseStaticImg(e){let t=null;return new Promise((n,i)=>{this.getImageFileFromUrl(e,"图片.gif",a=>{let o=new FileReader;o.onloadend=()=>{t=o.result,n(t);},o.readAsDataURL(a);});})}},async networkQueryContentType(e){let t=await b.head(e,{fetch:!0});if(t.status&&t.data.responseFetchHeaders.has("Content-Type"))return t.data.responseFetchHeaders.get("Content-Type")}},G=[{rule:".png",type:"image/png"},{rule:".jpg",type:"image/jpg"},{rule:".jpeg",type:"image/jpeg"},{rule:".webp",type:"image/webp"},{rule:".ico",type:"image/ico"},{rule:".gif",type:"image/gif"}],q={init(){let e=document.body.querySelectorAll("img");if(e.length!==1){f.error("页面中的<img>元素数量不为1");return}f.info("注入全局右键-图片");let t=e[0],n=t.src;m.rightClickMenu({target:p,data:[{icon:m.config.iconSVG.documentCopy,iconIsLoading:!1,text:"自动判断",async callback(){let i=null;if(n.startsWith("http")||n.startsWith("file:")){let a=-1;a=G.findIndex(o=>n.endsWith(o.rule)),a!==-1&&(i=G[a].type),!i&&n.startsWith("http")&&(r.info("通过网络请求判断类型"),i=await y.networkQueryContentType(n),f.info("请求获取的Content-Type："+i),i&&r.success("图片类型："+i));}i?i.endsWith("gif")?y.gif.chooseStaticImg(n).then(a=>{c.setClip(a),r.success("复制成功！");}):(c.setClip(y.default.getBase64Image(t,i)),r.success("复制成功！")):r.error("未知的图片类型");}},{icon:m.config.iconSVG.chromeFilled,iconIsLoading:!1,text:"其它类型",callback(i){return !1},item:[{icon:m.config.iconSVG.documentCopy,iconIsLoading:!1,text:"jpg",callback(){c.setClip(y.default.getBase64Image(t,"image/jpg")),r.success("复制成功！");}},{icon:m.config.iconSVG.documentCopy,iconIsLoading:!1,text:"jpeg",callback(){c.setClip(y.default.getBase64Image(t,"image/jpeg")),r.success("复制成功！");}},{icon:m.config.iconSVG.documentCopy,iconIsLoading:!1,text:"png",callback(){c.setClip(y.default.getBase64Image(t,"image/png")),r.success("复制成功！");}},{icon:m.config.iconSVG.documentCopy,iconIsLoading:!1,text:"gif",callback(){y.gif.chooseStaticImg(n).then(i=>{c.setClip(i),r.success("复制成功！");});}}]}]});}};document.documentElement.hasAttribute("style")&&document.body.hasAttribute("style")&&document.body.children.length&&document.querySelector('meta[name="viewport"]')&&(d.init(),q.init());

})(Qmsg, DOMUtils, Utils, pops);